<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">实时数仓开发 | Bigdata-Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sophiadata.github.io/Bigdata_Blog_Website/blog/实时数仓开发"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="实时数仓开发 | Bigdata-Blog"><meta data-rh="true" name="description" content="采集到 Kafka 的 topiclog 和 topicdb 主题的数据即为实时数仓的 ODS 层，这一层的作用是对数据做原样展示和备份。"><meta data-rh="true" property="og:description" content="采集到 Kafka 的 topiclog 和 topicdb 主题的数据即为实时数仓的 ODS 层，这一层的作用是对数据做原样展示和备份。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-12-11T04:38:38.000Z"><meta data-rh="true" property="article:author" content="https://github.com/rookiegao"><meta data-rh="true" property="article:tag" content="数据仓库"><link data-rh="true" rel="icon" href="/Bigdata_Blog_Website/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://sophiadata.github.io/Bigdata_Blog_Website/blog/实时数仓开发"><link data-rh="true" rel="alternate" href="https://sophiadata.github.io/Bigdata_Blog_Website/blog/实时数仓开发" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://sophiadata.github.io/Bigdata_Blog_Website/en/blog/实时数仓开发" hreflang="en"><link data-rh="true" rel="alternate" href="https://sophiadata.github.io/Bigdata_Blog_Website/blog/实时数仓开发" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Bigdata_Blog_Website/blog/rss.xml" title="Bigdata-Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Bigdata_Blog_Website/blog/atom.xml" title="Bigdata-Blog Atom Feed">



<link rel="preconnect" href="https://mc.yandex.ru">
<script>!function(e,t,a,c,n,m,r){e.ym=e.ym||function(){(e.ym.a=e.ym.a||[]).push(arguments)},e.ym.l=1*new Date,m=t.createElement(a),r=t.getElementsByTagName(a)[0],m.async=1,m.src="https://mc.yandex.ru/metrika/tag.js",r.parentNode.insertBefore(m,r)}(window,document,"script"),ym(91340636,"init",{defer:!0,clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!1,ecommerce:!1,trackHash:!1})</script>
<noscript>
                            <div><img src="https://mc.yandex.ru/watch/91340636" style="position:absolute; left:-9999px;" alt=""></div>
                        </noscript><link rel="stylesheet" href="/Bigdata_Blog_Website/assets/css/styles.86a34ffa.css">
<link rel="preload" href="/Bigdata_Blog_Website/assets/js/runtime~main.235b48d2.js" as="script">
<link rel="preload" href="/Bigdata_Blog_Website/assets/js/main.6b17f54e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Bigdata_Blog_Website/"><div class="navbar__logo"><img src="/Bigdata_Blog_Website/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/Bigdata_Blog_Website/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Bigdata_Blog</b></a><a class="navbar__item navbar__link" href="/Bigdata_Blog_Website/docs/overview">Note</a><a class="navbar__item navbar__link" href="/Bigdata_Blog_Website/document/overview">Blog recommendation</a><a class="navbar__item navbar__link" href="/Bigdata_Blog_Website/learning/overview">Framework learning</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Bigdata_Blog_Website/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/SophiaData/Bigdata_Blog_Website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/Bigdata_Blog_Website/blog/实时数仓开发" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/Bigdata_Blog_Website/en/blog/实时数仓开发" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/Bigdata_Blog_Website/docs/overview">1.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/Bigdata_Blog_Website/docs/next/overview">Next</a></li><li><a class="dropdown__link" href="/Bigdata_Blog_Website/docs/overview">1.1</a></li><li><a class="dropdown__link" href="/Bigdata_Blog_Website/docs/1.0/overview">1.0</a></li><li><a href="https://bigdata-note.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Old<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">全部博文</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/A Scala-free Flink">A Scala-free Flink</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/Doris 集成其他系统">Doris 集成其他系统</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/Flink OLAP 与 Trino TPC-DS 对比">Flink OLAP 与 Trino TPC-DS 对比</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/Hbase 与 ClickHouse 应用场景">Hbase 与 ClickHouse 应用场景</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/IDEA CheckStyle 配置">IDEA CheckStyle 配置</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/mysql cdc 整库同步">技术思想</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/Bigdata_Blog_Website/blog/实时数仓开发">实时数仓开发</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/实时数仓理论基础">实时数仓理论基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/数仓架构体系">数仓架构体系</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/离线数仓、实时数仓与 Data Lakehouse">离线数仓、实时数仓与 DataLakeHouse</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/Mac M1 Datasophon 安装">Mac M1 Datasophon 安装</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/Flink CDC 2.3.0 Announce">Flink CDC 2.3.0 Announce</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/debezium to oracle 11g 实时同步">debezium to oracle 11g 实时同步</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Bigdata_Blog_Website/blog/Ambari 入门及安装">Ambari 入门及安装</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">实时数仓开发</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-12-11T04:38:38.000Z" itemprop="datePublished">2022年12月11日</time> · <!-- -->阅读需 103 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rookiegao" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">skylines</span></a></div></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h1>数仓开发之ODS层</h1><p>采集到 Kafka 的 topic_log 和 topic_db 主题的数据即为实时数仓的 ODS 层，这一层的作用是对数据做原样展示和备份。</p><p>数仓开发之DIM层</p><p>DIM层设计要点：</p><p>（1）DIM层的设计依据是维度建模理论，该层存储维度模型的维度表。</p><p>（2）DIM层的数据存储在 HBase 表中</p><p>DIM 层表是用于维度关联的，要通过主键去获取相关维度信息，这种场景下 K-V 类型数据库的效率较高。</p><p>常见的 K-V 类型数据库有 Redis、HBase，而 Redis 的数据常驻内存，会给内存造成较大压力，因而选用 HBase 存储维度数据。</p><p>（3）DIM层表名的命名规范为dim_表名</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置表">配置表<a class="hash-link" href="#配置表" title="标题的直接链接">​</a></h2><p>本层的任务是将业务数据直接写入到不同的 HBase 表中。那么如何让程序知道流中的哪些数据是维度数据？</p><p>维度数据又应该写到 HBase 的哪些表中？</p><p>为了解决这个问题，我们选择在 MySQL 中构建一张配置表，通过 Flink CDC 将配置表信息读取到程序中。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="flink-cdc">Flink CDC<a class="hash-link" href="#flink-cdc" title="标题的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置表设计">配置表设计<a class="hash-link" href="#配置表设计" title="标题的直接链接">​</a></h3><p>1）字段解析</p><p>我们将为配置表设计五个字段</p><blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source_table：作为数据源的业务数据表名 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sink_table：作为数据目的地的 Phoenix 表名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sink_columns：Phoenix 表字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sink_pk：Phoenix 表主键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sink_extend：Phoenix 建表扩展，即建表时一些额外的配置语句</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>将 source_table 作为配置表的主键，可以通过它获取唯一的目标表名、字段、主键和建表扩展，从而得到完整的 Phoenix 建表语句。</p><p>2）在Mysql中创建数据库建表并开启Binlog</p><p>（1）创建数据库 gmall_config ，注意:和 gmall 业务库区分开</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[atguigu@hadoop102 db_log]$ mysql -uroot -p000000 -e&quot;create database gmall_config charset utf8 default collate utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（2）在 gmall_config 库中创建配置表 table_process</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `table_process` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `source_table` varchar(200) NOT NULL COMMENT &#x27;来源表&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `sink_table` varchar(200) DEFAULT NULL COMMENT &#x27;输出表&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `sink_columns` varchar(2000) DEFAULT NULL COMMENT &#x27;输出字段&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `sink_pk` varchar(200) DEFAULT NULL COMMENT &#x27;主键字段&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `sink_extend` varchar(200) DEFAULT NULL COMMENT &#x27;建表扩展&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`source_table`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（3）在MySQL配置文件中增加 gmall_config 开启Binlog</p><p>参考 Flink cdc 文档。</p><p>配置表建表及数据导入 SQL 文件如下。</p><p>略。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务">主要任务<a class="hash-link" href="#主要任务" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="接收kafka数据过滤空值数据">接收Kafka数据，过滤空值数据<a class="hash-link" href="#接收kafka数据过滤空值数据" title="标题的直接链接">​</a></h3><p>对Maxwell抓取的数据进行ETL，有用的部分保留，没用的过滤掉。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="动态拆分维度表功能">动态拆分维度表功能<a class="hash-link" href="#动态拆分维度表功能" title="标题的直接链接">​</a></h3><p>由于Maxwell是把全部数据统一写入一个Topic中, 这样显然不利于日后的数据处理。所以需要把各个维度表拆开处理。</p><p>在实时计算中一般把维度数据写入存储容器，一般是方便通过主键查询的数据库比如HBase,Redis,MySQL等。</p><p>这样的配置不适合写在配置文件中，因为这样的话，业务端随着需求变化每增加一张维度表表，就要修改配置重启计算程序。</p><p>所以这里需要一种动态配置方案，把这种配置长期保存起来，一旦配置有变化，实时计算可以自动感知。这种可以有三个方案实现：</p><ul><li><p>一种是用Zookeeper存储，通过Watch感知数据变化；</p></li><li><p>另一种是用mysql数据库存储，周期性的同步；</p></li><li><p>再一种是用mysql数据库存储，使用广播流。</p></li></ul><p>这里选择第三种方案，主要是MySQL对于配置数据初始化和维护管理，使用FlinkCDC读取配置信息表，将配置流作为广播流与主流进行连接。</p><p>所以就有了如下图：</p><p> <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242138-a6ab05fb-7e84-43af-a703-7c3af95b4f14.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="把流中的数据保存到对应的维度表">把流中的数据保存到对应的维度表<a class="hash-link" href="#把流中的数据保存到对应的维度表" title="标题的直接链接">​</a></h3><p>维度数据保存到HBase的表中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代码实现">代码实现<a class="hash-link" href="#代码实现" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="接收kafka数据过滤空值数据-1">接收Kafka数据，过滤空值数据<a class="hash-link" href="#接收kafka数据过滤空值数据-1" title="标题的直接链接">​</a></h3><p>1）创建 KafkaUtil 工具类</p><p>和 Kafka 交互要用到 Flink 提供的 FlinkKafkaConsumer、FlinkKafkaProducer 类，为了提高模板代码的复用性，将其封装到 KafkaUtil 工具类中。</p><p>此处从 Kafka 读取数据，创建 getKafkaConsumer(String topic, String groupId) 方法</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class KafkaUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static String BOOTSTRAP_SERVERS = &quot;hadoop102:9092, hadoop103:9092, hadoop104:9092&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static String DEFAULT_TOPIC = &quot;default_topic&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static FlinkKafkaConsumer&lt;String&gt;  getKafkaConsumer(String topic, String groupId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties prop = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop.setProperty(&quot;bootstrap.servers&quot;, BOOTSTRAP_SERVERS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop.setProperty(ConsumerConfig.GROUP_ID_CONFIG, groupId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkKafkaConsumer&lt;String&gt; consumer = new FlinkKafkaConsumer&lt;&gt;(topic,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new KafkaDeserializationSchema&lt;String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public boolean isEndOfStream(String nextElement) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public String deserialize(ConsumerRecord&lt;byte[], byte[]&gt; record) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if(record != null &amp;&amp; record.value() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            return new String(record.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public TypeInformation&lt;String&gt; getProducedType() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return TypeInformation.of(String.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, prop);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return consumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class DimSinkApp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                10, Time.of(1L, TimeUnit.DAYS), Time.of(3L, TimeUnit.MINUTES)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/gmall/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 读取业务主流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String topic = &quot;topic_db&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String groupId = &quot;dim_sink_app&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStreamSource&lt;String&gt; gmallDS = env.addSource(KafkaUtil.getKafkaConsumer(topic, groupId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 主流数据结构转换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; jsonDS = gmallDS.map(JSON::parseObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 主流 ETL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; filterDS = jsonDS.filter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                jsonObj -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        jsonObj.getJSONObject(&quot;data&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if(jsonObj.getString(&quot;type&quot;).equals(&quot;bootstrap-start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || jsonObj.getString(&quot;type&quot;).equals(&quot;bootstrap-complete&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (JSONException jsonException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 打印测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterDS.print(&quot;filterDS &gt;&gt;&gt; &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="根据mysql的配置表动态进行分流">根据MySQL的配置表，动态进行分流<a class="hash-link" href="#根据mysql的配置表动态进行分流" title="标题的直接链接">​</a></h3><p>1）导入依赖</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;flink-connector-jdbc_${scala.version}&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;${flink.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.ververica&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;flink-connector-mysql-cdc&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.1.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.phoenix&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;phoenix-spark&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;5.0.0-HBase-2.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.glassfish&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;javax.el&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;!-- 如果不引入 flink-table 相关依赖，则会报错：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.lang.ClassNotFoundException: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.flink.connector.base.source.reader.RecordEmitter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">引入以下依赖可以解决这个问题（引入某些其它的 flink-table相关依赖也可）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;flink-table-api-java-bridge_2.12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.13.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）创建配置表实体类</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TableProcess {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //来源表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String sourceTable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //输出表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String sinkTable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //输出字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String sinkColumns;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //主键字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String sinkPk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //建表扩展</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String sinkExtend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4）编写操作读取配置表形成广播流</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// TODO 6. FlinkCDC 读取配置流并广播流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.1 FlinkCDC 读取配置表信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MySqlSource&lt;String&gt; mySqlSource = MySqlSource.&lt;String&gt;builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .hostname(&quot;hadoop102&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(3306)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .databaseList(&quot;gmall_config&quot;) // set captured database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .tableList(&quot;gmall_config.table_process&quot;) // set captured table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .username(&quot;root&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .password(&quot;000000&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .deserializer(new JsonDebeziumDeserializationSchema()) // converts SourceRecord to JSON String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .startupOptions(StartupOptions.initial())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.2 封装为流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStreamSource&lt;String&gt; mysqlDSSource = env.fromSource(mySqlSource, WatermarkStrategy.noWatermarks(), &quot;MysqlSource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.3 广播配置流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MapStateDescriptor&lt;String, TableProcess&gt; tableConfigDescriptor = new MapStateDescriptor&lt;String, TableProcess&gt;(&quot;table-process-state&quot;, String.class, TableProcess.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BroadcastStream&lt;String&gt; broadcastDS = mysqlDSSource.broadcast(tableConfigDescriptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 连接流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BroadcastConnectedStream&lt;JSONObject, String&gt; connectedStream = filterDS.connect(broadcastDS);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5）定义一个项目中常用的配置常量类GmallConfig</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.common;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class GmallConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Phoenix库名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String HBASE_SCHEMA = &quot;GMALL2022_REALTIME&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Phoenix驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String PHOENIX_DRIVER = &quot;org.apache.phoenix.jdbc.PhoenixDriver&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Phoenix连接参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String PHOENIX_SERVER = &quot;jdbc:phoenix:hadoop102,hadoop103,hadoop104:2181&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6）自定义函数MyBroadcastFunction</p><p> <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242215-ed2186bf-6999-4501-bf09-e7c855071ae1.png" alt="img" class="img_ev3q"></p><p>（1）定义类MyBroadcastFunction</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.func;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.functions.co.BroadcastProcessFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.Collector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.OutputTag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyBroadcastFunction extends BroadcastProcessFunction&lt;JSONObject, String, JSONObject&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MapStateDescriptor&lt;String, TableProcess&gt; tableConfigDescriptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public MyBroadcastFunction(MapStateDescriptor&lt;String, TableProcess&gt; tableConfigDescriptor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.tableConfigDescriptor = tableConfigDescriptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void processElement(JSONObject jsonObj, ReadOnlyContext readOnlyContext, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void processBroadcastElement(String jsonStr, Context context, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（2）自定义函数MyBroadcastFunction-open</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 定义Phoenix的连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private Connection conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void open(Configuration parameter) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.open(parameter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class.forName(GmallConfig.PHOENIX_DRIVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        conn = DriverManager.getConnection(GmallConfig.PHOENIX_SERVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（3）自定义函数MyBroadcastFunction-processBroadcastElement</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void processBroadcastElement(String jsonStr, Context context, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSONObject jsonObj = JSON.parseObject(jsonStr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TableProcess config = jsonObj.getObject(&quot;after&quot;, TableProcess.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sourceTable = config.getSourceTable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sinkTable = config.getSinkTable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sinkColumns = config.getSinkColumns();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sinkPk = config.getSinkPk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sinkExtend = config.getSinkExtend();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BroadcastState&lt;String, TableProcess&gt; tableConfigState = context.getBroadcastState(tableConfigDescriptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableConfigState.put(sourceTable, config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        checkTable(sinkTable, sinkColumns, sinkPk, sinkExtend);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（4）自定义函数MyBroadcastFunction-checkTable</p><p>在 Phoenix 建表之前要先创建命名空间 GMALL2022_REALTIM。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0: jdbc:phoenix:&gt; create schema GMALL2022_REALTIME;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">checkTable() 方法如下</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Phoenix 建表函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sinkTable 目标表名  eg. test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sinkColumns 目标表字段  eg. id,name,sex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sinkPk 目标表主键  eg. id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sinkExtend 目标表建表扩展字段  eg. &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *                   eg. create table if not exists mydb.test(id varchar primary key, name varchar, sex varchar)...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void checkTable(String sinkTable, String sinkColumns, String sinkPk, String sinkExtend) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 封装建表 SQL </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder sql = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql.append(&quot;create table if not exists &quot; + GmallConfig.HBASE_SCHEMA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;.&quot; + sinkTable + &quot;(\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] columnArr = sinkColumns.split(&quot;,&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 为主键及扩展字段赋默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (sinkPk == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sinkPk = &quot;id&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (sinkExtend == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sinkExtend = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历添加字段信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; columnArr.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sql.append(columnArr[i] + &quot; varchar&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 判断当前字段是否为主键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (sinkPk.equals(columnArr[i])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sql.append(&quot; primary key&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果当前字段不是最后一个字段，则追加&quot;,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt; columnArr.length - 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sql.append(&quot;,\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql.append(&quot;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql.append(sinkExtend);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String createStatement = sql.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 为数据库操作对象赋默认值，执行建表 SQL </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement preparedSt = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedSt = conn.prepareStatement(createStatement);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedSt.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException sqlException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sqlException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;建表语句\n&quot; + createStatement + &quot;\n执行异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (preparedSt != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    preparedSt.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (SQLException sqlException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sqlException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(&quot;数据库操作对象释放异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（5）自定义函数MyBroadcastFunction-processElement()</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void processElement(JSONObject jsonObj, ReadOnlyContext readOnlyContext, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ReadOnlyBroadcastState&lt;String, TableProcess&gt; tableConfigState = readOnlyContext.getBroadcastState(tableConfigDescriptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // 获取配置信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       String sourceTable = jsonObj.getString(&quot;table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       TableProcess tableConfig = tableConfigState.get(sourceTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (tableConfig != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           JSONObject data = jsonObj.getJSONObject(&quot;data&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           String sinkTable = tableConfig.getSinkTable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 根据 sinkColumns 过滤数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           String sinkColumns = tableConfig.getSinkColumns();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           filterColumns(data, sinkColumns);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 将目标表名加入到主流数据中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           data.put(&quot;sinkTable&quot;, sinkTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           out.collect(data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（6）自定义函数MyBroadcastFunction-filterColumns()，校验字段，过滤掉多余的字段</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void filterColumns(JSONObject data, String sinkColumns) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;Map.Entry&lt;String, Object&gt;&gt; dataEntries = data.entrySet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataEntries.removeIf(r -&gt; !sinkColumns.contains(r.getKey()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（7）主程序DimSinkApp中调用MyBroadcastFunction提取维度数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// TODO 8. 处理维度表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; dimDS = connectedStream.process(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new MyBroadcastFunction(tableConfigDescriptor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="保存维度到hbasephoenix">保存维度到HBase(Phoenix)<a class="hash-link" href="#保存维度到hbasephoenix" title="标题的直接链接">​</a></h3><p>1）程序流程分析</p><p> <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242508-adc1dcaa-f20d-4c50-8d52-02eb20e6a79f.png" alt="img" class="img_ev3q"></p><p>DimSink 继承了RickSinkFunction，这个function得分两条时间线：</p><p>一条是任务启动时执行open操作（图中紫线），我们可以把连接的初始化工作放在此处一次性执行；</p><p>另一条是随着每条数据的到达反复执行invoke()（图中黑线）,在这里面我们要实现数据的保存，主要策略就是根据数据组合成sql提交给hbase。</p><p>3）创建 PhoenixUtil 工具类，在其中创建initializeConnection()方法和insertValues()方法</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.util;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.common.GmallConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.commons.beanutils.BeanUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.commons.lang3.StringUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PhoenixUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 定义数据库连接对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static Connection conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 初始化 SQL 执行环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void initializeConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1. 注册驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Class.forName(&quot;org.apache.phoenix.jdbc.PhoenixDriver&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. 获取连接对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn = DriverManager.getConnection(&quot;jdbc:phoenix:hadoop102,hadoop103,hadoop104:2181&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. 设置 Phoenix SQL 执行使用的 schema（对应 mysql 的 database）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.setSchema(GmallConfig.HBASE_SCHEMA);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ClassNotFoundException classNotFoundException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;注册驱动异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classNotFoundException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException sqlException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;获取连接对象异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sqlException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Phoenix 表数据导入方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sinkTable 写入数据的 Phoenix 目标表名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data 待写入的数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void insertValues(String sinkTable, JSONObject data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 双重校验锁初始化连接对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(conn == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized (PhoenixUtil.class) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if(conn == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    initializeConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取字段名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; columns = data.keySet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取字段对应的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;Object&gt; values = data.values();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 拼接字段名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String columnStr = StringUtils.join(columns, &quot;,&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 拼接字段值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String valueStr = StringUtils.join(values, &quot;&#x27;,&#x27;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 拼接插入语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;upsert into &quot; + GmallConfig.HBASE_SCHEMA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;.&quot; + sinkTable + &quot;(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                columnStr + &quot;) values (&#x27;&quot; + valueStr + &quot;&#x27;)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 为数据库操作对象赋默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement preparedSt = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行 SQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;插入语句为:&quot; + sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedSt = conn.prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedSt.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException sqlException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sqlException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(&quot;数据库操作对象获取或执行异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(preparedSt != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    preparedSt.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (SQLException sqlException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sqlException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(&quot;数据库操作对象释放异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4）MyPhoenixSink</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">自定义 SinkFunction 子类 MyPhoenixSink，在其中调用 Phoenix 工具类的 insertValues(String sinkTable, JSONObject data) 方法，将维度数据写出到 Phoenix 的维度表中。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.func;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.PhoenixUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyPhoenixSink implements SinkFunction&lt;JSONObject&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void invoke(JSONObject jsonObj, Context context) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取目标表表名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sinkTable = jsonObj.getString(&quot;sinkTable&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 清除 JSON 对象中的 sinkTable 字段，以便可将该对象直接用于 HBase 表的数据写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jsonObj.remove(&quot;sinkTable&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PhoenixUtil.insertValues(sinkTable, jsonObj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5）主程序 DimSinkApp 中调用 MyPhoenixSink</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// TODO 9. 将数据写入 Phoenix 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dimDS.addSink(new MyPhoenixSink());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6）测试</p><p>（1）启动HDFS、ZK、Kafka、Maxwell、HBase</p><p>（2）运行 IDEA 中的 DimSinkApp</p><p>（3）执行 mysql_to_kafka_init.sh 脚本</p><p>mysql_to_kafka_init.sh all</p><p>（6）通过phoenix查看hbase的schema以及表情况</p><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242537-b7d64239-fd24-4615-af0f-37dc0d4b4245.png" alt="img" class="img_ev3q"></p><h1>数仓开发之DWD层</h1><p>DWD层设计要点：</p><p>（1）DWD层的设计依据是维度建模理论，该层存储维度模型的事实表。</p><p>（2）DWD层表名的命名规范为dwd<em>数据域</em>表名</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="流量域未经加工的事务事实表">流量域未经加工的事务事实表<a class="hash-link" href="#流量域未经加工的事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-1">主要任务<a class="hash-link" href="#主要任务-1" title="标题的直接链接">​</a></h3><p>1）数据清洗（ETL）</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">数据传输过程中可能会出现部分数据丢失的情况，导致 JSON 数据结构不再完整，因此需要对脏数据进行过滤。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）新老访客状态标记修复</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">日志数据 common 字段下的 is_new 字段是用来标记新老访客状态的，1 表示新访客，2 表示老访客。前端埋点采集到的数据可靠性无法保证，可能会出现老访客被标记为新访客的问题，因此需要对该标记进行修复。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）分流</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">本节将通过分流对日志数据进行拆分，生成五张事务事实表写入 Kafka</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">流量域页面浏览事务事实表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">流量域启动事务事实表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">流量域动作事务事实表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">流量域曝光事务事实表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">流量域错误事务事实表</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路">思路<a class="hash-link" href="#思路" title="标题的直接链接">​</a></h3></blockquote><p>1）数据清洗（ETL）</p><p>对流中数据进行解析，将字符串转换为 JSONObject，如果解析报错则必然为脏数据。定义侧输出流，将脏数据发送到侧输出流，写入 Kafka 脏数据主题</p><p>2）新老访客状态标记修复</p><p>（1）前端埋点新老访客状态标记设置规则</p><p>以神策提供的第三方埋点服务中新老访客状态标记设置规则为例</p><blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- Web 端：用户第一次访问埋入神策 SDK 页面的当天（即第一天），JS SDK 会在网页的 cookie 中设置一个首日访问的标记，并设置第一天 24 点之前，该标记为 true，即第一天触发的网页端所有事件中，is_new = 1。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">第一天之后，该标记则为 false，即第一天之后触发的网页端所有事件中，is_new = 0；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 小程序端：用户第一天访问埋入神策 SDK 的页面时，小程序 SDK 会在 storage 缓存中创建一个首日为 true 的标记，并且设置第一天 24 点之前，该标记均为 true。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">即第一天触发的小程序端所有事件中，is_new = 1。第一天之后，该标记则为 false，即第一天之后触发的小程序端所有事件中，is_new = 0；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- APP 端：用户安装 App 后，第一次打开埋入神策 SDK 的 App 的当天，Android/iOS SDK 会在手机本地缓存内，创建一个首日为 true 的标记，并且设置第一天 24 点之前，该标记均为 true。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">即第一天触发的 APP 端所有事件中，is_new = 1。第一天之后，该标记则为 false，即第一天之后触发的 APP 端所有事件中，is_new = 0。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>本项目模拟生成的是 APP 端日志数据。对于此类日志，如果首日之后用户清除了手机本地缓存中的标记，再次启动 APP 会重新设置一个首日为 true 的标记，导致本应为 0 的 is_new 字段被置为 1，可能会给相关指标带来误差。</p></blockquote><p>因此，有必要对新老访客状态标记进行修复。</p><p>（2）新老访客状态标记修复思路</p><p>运用 Flink 状态编程，为每个 mid 维护一个键控状态，记录首次访问日期。</p><p>①如果 is_new 的值为 1</p><p>a）如果键控状态为 null，认为本次是该访客首次访问 APP，将日志中 ts 对应的日期更新到状态中，不对 is_new 字段做修改；</p><p>b）如果键控状态不为 null，且首次访问日期不是当日，说明访问的是老访客，将 is_new 字段置为 0；</p><p>c）如果键控状态不为 null，且首次访问日期是当日，说明访问的是新访客，不做操作；</p><p>②如果 is_new 的值为 0</p><p>a）如果键控状态为 null，说明访问 APP 的是老访客但本次是该访客的页面日志首次进入程序。当前端新老访客状态标记丢失时，日志进入程序被判定为老访客，Flink 程序就可以纠正被误判的访客状态标记，只要将状态中的日期设置为今天之前即可。本程序选择将状态更新为昨日；</p><p>b）如果键控状态不为 null，说明程序已经维护了首次访问日期，不做操作。</p><p>3）利用侧输出流实现数据拆分</p><p>（1）埋点日志结构分析</p><p>前端埋点获取的 JSON 字符串（日志）可能存在 common、start、page、displays、actions、err 六种字段。其中</p><ul><li>common 对应的是公共信息，是所有日志都有的字段</li><li>err 对应的是错误信息，所有日志都可能有的字段</li><li>start 对应的是启动信息，启动日志才有的字段</li><li>page 对应的是页面信息，页面日志才有的字段</li><li>displays 对应的是曝光信息，曝光日志才有的字段，曝光日志可以归为页面日志，因此必然有 page 字段</li><li>actions 对应的是动作信息，动作日志才有的字段，同样属于页面日志，必然有 page 字段。动作信息和曝光信息可以同时存在。</li><li>ts 对应的是时间戳，单位：毫秒，所有日志都有的字段</li></ul><p>综上，我们可以将前端埋点获取的日志分为两大类：启动日志和页面日志。</p><p>二者都有 common 字段和 ts 字段，都可能有 err 字段。页面日志一定有 page 字段，一定没有 start 字段，可能有 displays 和 actions 字段；</p><p>启动日志一定有 start 字段，一定没有 page、displays 和 actions 字段。</p><p>（2）分流日志分类</p><p>本节将按照内容，将日志分为以下五类</p><ul><li>启动日志</li><li>页面日志</li><li>曝光日志</li><li>动作日志</li><li>错误日志
（3）分流思路</li></ul><p>①所有日志数据都可能拥有 err 字段，所有首先获取 err 字段，如果返回值不为 null 则将整条日志数据发送到错误侧输出流。然后删掉 JSONObject 中的 err 字段及对应值；</p><p>②判断是否有 start 字段，如果有则说明数据为启动日志，将其发送到启动侧输出流；如果没有则说明为页面日志，进行下一步；</p><p>③页面日志必然有 page 字段、 common 字段和 ts 字段，获取它们的值，ts 封装为包装类 Long，其余两个字段的值封装为 JSONObject；</p><p>④判断是否有 displays 字段，如果有，将其值封装为 JSONArray，遍历该数组，依次获取每个元素（记为 display），封装为JSONObject。创建一个空的 JSONObject，将 display、common、page和 ts 添加到该对象中，获得处理好的曝光数据，发送到曝光侧输出流。动作日志的处理与曝光日志相同（注意：一条页面日志可能既有曝光数据又有动作数据，二者没有任何关系，因此曝光数据不为 null 时仍要对动作数据进行处理）；</p><p>⑤动作日志和曝光日志处理结束后删除 displays 和 actions 字段，此时主流的 JSONObject 中只有 common 字段、 page 字段和 ts 字段，即为最终的页面日志。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">处理结束后，页面日志数据位于主流，其余四种日志分别位于对应的侧输出流，将五条流的数据写入 Kafka 对应主题即可。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解">图解<a class="hash-link" href="#图解" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242565-609d3749-447a-454f-880a-aad215e3763f.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码">代码<a class="hash-link" href="#代码" title="标题的直接链接">​</a></h3><p>1）在 KafkaUtil 工具类中补充 getKafkaProducer() 方法</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static FlinkKafkaProducer&lt;String&gt; getKafkaProducer(String topic) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties prop = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop.setProperty(&quot;bootstrap.servers&quot;, BOOTSTRAP_SERVERS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop.setProperty(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG, 60 * 15 * 1000 + &quot;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkKafkaProducer&lt;String&gt; producer = new FlinkKafkaProducer&lt;String&gt;(DEFAULT_TOPIC, new KafkaSerializationSchema&lt;String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public ProducerRecord&lt;byte[], byte[]&gt; serialize(String jsonStr, @Nullable Long timestamp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ProducerRecord&lt;byte[], byte[]&gt;(topic, jsonStr.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, prop,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                FlinkKafkaProducer.Semantic.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return producer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）创建 DateFormatUtil 工具类用于日期格式化</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.util;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.LocalDateTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.LocalTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneOffset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.format.DateTimeFormatter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Date;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DateFormatUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final DateTimeFormatter dtf = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final DateTimeFormatter dtfFull = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Long toTs(String dtStr, boolean isFull) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDateTime localDateTime = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!isFull) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dtStr = dtStr + &quot; 00:00:00&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        localDateTime = LocalDateTime.parse(dtStr, dtfFull);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return localDateTime.toInstant(ZoneOffset.of(&quot;+8&quot;)).toEpochMilli();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Long toTs(String dtStr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return toTs(dtStr, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String toDate(Long ts) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date dt = new Date(ts);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDateTime localDateTime = LocalDateTime.ofInstant(dt.toInstant(), ZoneId.systemDefault());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dtf.format(localDateTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String toYmdHms(Long ts) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date dt = new Date(ts);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDateTime localDateTime = LocalDateTime.ofInstant(dt.toInstant(), ZoneId.systemDefault());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dtfFull.format(localDateTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(toYmdHms(System.currentTimeMillis()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONArray;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.DateFormatUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.state.ValueState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.state.ValueStateDescriptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.KeyedStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.functions.KeyedProcessFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.functions.ProcessFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.Collector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.OutputTag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BaseLogApp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 启用状态后端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .failureRateRestart(10,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Time.of(3L, TimeUnit.DAYS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Time.of(1L, TimeUnit.MINUTES)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/gmall/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取主流数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String topic = &quot;topic_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String groupId = &quot;base_log_consumer&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStreamSource&lt;String&gt; source = env.addSource(KafkaUtil.getKafkaConsumer(topic, groupId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 数据清洗，转换结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.1 定义错误侧输出流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputTag&lt;String&gt; dirtyStreamTag = new OutputTag&lt;String&gt;(&quot;dirtyStream&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;String&gt; cleanedStream = source.process(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new ProcessFunction&lt;String, String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void processElement(String jsonStr, Context ctx, Collector&lt;String&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            JSONObject jsonObj = JSON.parseObject(jsonStr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            out.collect(jsonStr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ctx.output(dirtyStreamTag, jsonStr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.2 将脏数据写出到 Kafka 指定主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;String&gt; dirtyStream = cleanedStream.getSideOutput(dirtyStreamTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String dirtyTopic = &quot;dirty_data&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dirtyStream.addSink(KafkaUtil.getKafkaProducer(dirtyTopic));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.3 转换主流数据结构 jsonStr -&gt; jsonObj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; mappedStream = cleanedStream.map(JSON::parseObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 新老访客状态标记修复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5.1 按照 mid 对数据进行分组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KeyedStream&lt;JSONObject, String&gt; keyedStream = mappedStream.keyBy(r -&gt; r.getJSONObject(&quot;common&quot;).getString(&quot;mid&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5.2 新老访客状态标记修复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; fixedStream = keyedStream.process(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new KeyedProcessFunction&lt;String, JSONObject, JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ValueState&lt;String&gt; firstViewDtState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void open(Configuration param) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        super.open(param);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        firstViewDtState = getRuntimeContext().getState(new ValueStateDescriptor&lt;String&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;lastLoginDt&quot;, String.class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void processElement(JSONObject jsonObj, Context ctx, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String isNew = jsonObj.getJSONObject(&quot;common&quot;).getString(&quot;is_new&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String firstViewDt = firstViewDtState.value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Long ts = jsonObj.getLong(&quot;ts&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String dt = DateFormatUtil.toDate(ts);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (&quot;1&quot;.equals(isNew)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (firstViewDt == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                firstViewDtState.update(dt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (!firstViewDt.equals(dt)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    isNew = &quot;0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    jsonObj.getJSONObject(&quot;common&quot;).put(&quot;is_new&quot;, isNew);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (firstViewDt == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // 将首次访问日期置为昨日</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                String yesterday = DateFormatUtil.toDate(ts - 1000 * 60 * 60 * 24);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                firstViewDtState.update(yesterday);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        out.collect(jsonObj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 分流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.1 定义启动、曝光、动作、错误侧输出流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputTag&lt;String&gt; startTag = new OutputTag&lt;String&gt;(&quot;startTag&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputTag&lt;String&gt; displayTag = new OutputTag&lt;String&gt;(&quot;displayTag&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputTag&lt;String&gt; actionTag = new OutputTag&lt;String&gt;(&quot;actionTag&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputTag&lt;String&gt; errorTag = new OutputTag&lt;String&gt;(&quot;errorTag&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.2 分流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;String&gt; separatedStream = fixedStream.process(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new ProcessFunction&lt;JSONObject, String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void processElement(JSONObject jsonObj, Context context, Collector&lt;String&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 6.2.1 收集错误数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        JSONObject error = jsonObj.getJSONObject(&quot;err&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (error != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            context.output(errorTag, jsonObj.toJSONString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 剔除 &quot;err&quot; 字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        jsonObj.remove(&quot;err&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 6.2.2 收集启动数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        JSONObject start = jsonObj.getJSONObject(&quot;start&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (start != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            context.output(startTag, jsonObj.toJSONString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 获取 &quot;page&quot; 字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            JSONObject page = jsonObj.getJSONObject(&quot;page&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 获取 &quot;common&quot; 字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            JSONObject common = jsonObj.getJSONObject(&quot;common&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 获取 &quot;ts&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            Long ts = jsonObj.getLong(&quot;ts&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 6.2.3 收集曝光数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            JSONArray displays = jsonObj.getJSONArray(&quot;displays&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (displays != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                for (int i = 0; i &lt; displays.size(); i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    JSONObject display = displays.getJSONObject(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    JSONObject displayObj = new JSONObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    displayObj.put(&quot;display&quot;, display);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    displayObj.put(&quot;common&quot;, common);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    displayObj.put(&quot;page&quot;, page);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    displayObj.put(&quot;ts&quot;, ts);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    context.output(displayTag, displayObj.toJSONString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 6.2.4 收集动作数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            JSONArray actions = jsonObj.getJSONArray(&quot;actions&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (actions != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                for (int i = 0; i &lt; actions.size(); i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    JSONObject action = actions.getJSONObject(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    JSONObject actionObj = new JSONObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    actionObj.put(&quot;action&quot;, action);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    actionObj.put(&quot;common&quot;, common);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    actionObj.put(&quot;page&quot;, page);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    actionObj.put(&quot;ts&quot;, ts);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    context.output(actionTag, actionObj.toJSONString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 6.2.5 收集页面数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            jsonObj.remove(&quot;displays&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            jsonObj.remove(&quot;actions&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            out.collect(jsonObj.toJSONString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 打印主流和各侧输出流查看分流效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        separatedStream.print(&quot;page&gt;&gt;&gt;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        separatedStream.getSideOutput(startTag).print(&quot;start!!!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        separatedStream.getSideOutput(displayTag).print(&quot;display@@@&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        separatedStream.getSideOutput(actionTag).print(&quot;action###&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        separatedStream.getSideOutput(errorTag).print(&quot;error$$$&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 将数据输出到 Kafka 的不同主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7.1 提取各侧输出流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;String&gt; startDS = separatedStream.getSideOutput(startTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;String&gt; displayDS = separatedStream.getSideOutput(displayTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;String&gt; actionDS = separatedStream.getSideOutput(actionTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;String&gt; errorDS = separatedStream.getSideOutput(errorTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7.2 定义不同日志输出到 Kafka 的主题名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String page_topic = &quot;dwd_traffic_page_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String start_topic = &quot;dwd_traffic_start_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String display_topic = &quot;dwd_traffic_display_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String action_topic = &quot;dwd_traffic_action_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String error_topic = &quot;dwd_traffic_error_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        separatedStream.addSink(KafkaUtil.getKafkaProducer(page_topic));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        startDS.addSink(KafkaUtil.getKafkaProducer(start_topic));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        displayDS.addSink(KafkaUtil.getKafkaProducer(display_topic));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionDS.addSink(KafkaUtil.getKafkaProducer(action_topic));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        errorDS.addSink(KafkaUtil.getKafkaProducer(error_topic));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="流量域独立访客事务事实表">流量域独立访客事务事实表<a class="hash-link" href="#流量域独立访客事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-2">主要任务<a class="hash-link" href="#主要任务-2" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">过滤页面数据中的独立访客访问记录。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析">思路分析<a class="hash-link" href="#思路分析" title="标题的直接链接">​</a></h3><p>1）过滤 last_page_id 不为 null 的数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">独立访客数据对应的页面必然是会话起始页面，last_page_id 必为 null。过滤 last_page_id != null 的数据，减小数据量，提升计算效率。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）筛选独立访客记录</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">运用 Flink 状态编程，为每个 mid 维护一个键控状态，记录末次登录日期。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果末次登录日期为 null 或者不是今日，则本次访问是该 mid 当日首次访问，保留数据，将末次登录日期更新为当日。否则不是当日首次访问，丢弃数据。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）状态存活时间设置</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">如果保留状态，第二日同一 mid 再次访问时会被判定为新访客，如果清空状态，判定结果相同，所以只要时钟进入第二日状态就可以清空。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设置状态的 TTL 为 1 天，更新模式为 OnCreateAndWrite，表示在创建和更新状态时重置状态存活时间。</p><p>如：2022-02-21 08:00:00 首次访问，若 2022-02-22 没有访问记录，则 2022-02-22 08:00:00 之后状态清空。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-1">图解<a class="hash-link" href="#图解-1" title="标题的直接链接">​</a></h3><p>  <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242617-99e9fac8-1ce0-480b-aeda-6166a13aa3bc.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-1">代码<a class="hash-link" href="#代码-1" title="标题的直接链接">​</a></h3><p>1）主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.DateFormatUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.functions.MapFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.functions.RichFilterFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.state.StateTtlConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.state.ValueState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.state.ValueStateDescriptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.KeyedStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTrafficUniqueVisitorDetail {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(30 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 kafka dwd_traffic_page_log 主题读取日志数据，封装为流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String topic = &quot;dwd_traffic_page_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String groupId = &quot;dwd_traffic_user_jump_detail&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkKafkaConsumer&lt;String&gt; kafkaConsumer = KafkaUtil.getKafkaConsumer(topic, groupId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStreamSource&lt;String&gt; pageLog = env.addSource(kafkaConsumer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 转换结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; mappedStream = pageLog.map(JSON::parseObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 过滤 last_page_id 不为 null 的数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; firstPageStream = mappedStream.filter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                jsonObj -&gt; jsonObj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .getJSONObject(&quot;page&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .getString(&quot;last_page_id&quot;) == null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 按照 mid 分组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KeyedStream&lt;JSONObject, String&gt; keyedStream = firstPageStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .keyBy(jsonObj -&gt; jsonObj.getJSONObject(&quot;common&quot;).getString(&quot;mid&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 通过 Flink 状态编程过滤独立访客记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; filteredStream = keyedStream.filter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new RichFilterFunction&lt;JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    private ValueState&lt;String&gt; lastVisitDt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void open(Configuration paramenters) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        super.open(paramenters);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ValueStateDescriptor&lt;String&gt; valueStateDescriptor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new ValueStateDescriptor&lt;&gt;(&quot;last_visit_dt&quot;, String.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        valueStateDescriptor.enableTimeToLive(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                StateTtlConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        .newBuilder(Time.days(1L))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        // 设置在创建和更新状态时更新存活时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        .setUpdateType(StateTtlConfig.UpdateType.OnCreateAndWrite)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        lastVisitDt = getRuntimeContext().getState(valueStateDescriptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public boolean filter(JSONObject jsonObj) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String visitDt = DateFormatUtil.toDate(jsonObj.getLong(&quot;ts&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String lastDt = lastVisitDt.value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (lastDt == null || !lastDt.equals(visitDt)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lastVisitDt.update(visitDt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 将独立访客数据写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Kafka dwd_traffic_unique_visitor_detail 主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String targetTopic = &quot;dwd_traffic_unique_visitor_detail&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkKafkaProducer&lt;String&gt; kafkaProducer = KafkaUtil.getKafkaProducer(targetTopic);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filteredStream.map(JSONAware::toJSONString).addSink(kafkaProducer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 9. 启动任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="流量域用户跳出事务事实表">流量域用户跳出事务事实表<a class="hash-link" href="#流量域用户跳出事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-3">主要任务<a class="hash-link" href="#主要任务-3" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">过滤用户跳出明细数据。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-1">思路分析<a class="hash-link" href="#思路分析-1" title="标题的直接链接">​</a></h3><p>1）筛选策略</p><p>跳出是指会话中只有一个页面的访问行为，如果能获取会话的所有页面，只要筛选页面数为 1 的会话即可获取跳出明细数据。</p><p>（1）离线数仓中我们可以获取一整天的数据，结合访问时间、page_id 和 last_page_id 字段对整体数据集做处理可以按照会话对页面日志进行划分，从而获得每个会话的页面数，只要筛选页面数为 1 的会话即可提取跳出明细数据；</p><p>（2）实时计算中无法考虑整体数据集，很难按照会话对页面访问记录进行划分。而本项目模拟生成的日志数据中没有 session_id（会话id）字段，也无法通过按照 session_id 分组的方式计算每个会话的页面数。</p><p>（3）因此，我们需要换一种解决思路。如果能判定首页日志之后没有同一会话的页面访问记录同样可以筛选跳出数据。如果日志数据完全有序，会话页面不存在交叉情况，则跳出页面的判定可以分为三种情况：</p><p>① 两条紧邻的首页日志进入算子，可以判定第一条首页日志所属会话为跳出会话；</p><p>② 第一条首页日志进入算子后，接收到的第二条日志为非首页日志，则第一条日志所属会话不是跳出会话；</p><p>③ 第一条首页日志进入算子后，没有收到第二条日志，此时无法得出结论，必须继续等待。但是无休止地等待显然是不现实的。</p><p>因此，人为设定超时时间，超时时间内没有第二条数据就判定为跳出行为，这是一种近似处理，存在误差，但若能结合业务场景设置合理的超时时间，误差是可以接受的。</p><p>本程序为了便于测试，设置超时时间为 10s，为了更快看到效果可以设置更小的超时时间，生产环境的设置结合业务需求确定。</p><p>由上述分析可知，情况 ① 的首页数据和情况 ③ 中的超时数据为跳出明细数据。</p><p>2）知识储备</p><p>（1）Flink CEP
跳出行为需要考虑会话中的两条页面日志数据（第一条为首页日志且超时时间内没有接收到第二条，或两条紧邻的首页日志到来可以判定第一条为跳出数据），要筛选的是组合事件，用 filter 无法实现这样的功能，由此引出 Flink CEP。</p><p>Flink CEP（Complex Event Processing 复杂事件处理）是在Flink上层实现的复杂事件处理库，可以在无界流中检测出特定的事件模型。</p><p>用户定义复杂规则（Pattern），将其应用到流上，即可从流中提取满足 Pattern 的一个或多个简单事件构成的复杂事件。</p><p>（2）Flink CEP 定义的规则之间的连续策略</p><ul><li>严格连续: 期望所有匹配的事件严格的一个接一个出现，中间没有任何不匹配的事件。对应方法为 next()；</li><li>松散连续: 忽略匹配的事件之间的不匹配的事件。对应方法为followedBy()；</li><li>不确定的松散连续: 更进一步的松散连续，允许忽略掉一些匹配事件的附加匹配。对应方法为followedByAny()。</li></ul><p>3）实现步骤</p><p>（1）按照 mid 分组</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">不同访客的浏览记录互不干涉，跳出行为的分析应在相同 mid 下进行，首先按照 mid 分组。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（2）定义 CEP 匹配规则</p><p>①规则一
跳出行为对应的页面日志必然为某一会话的首页，因此第一个规则判定 last_page_id 是否为 null，是则返回 true，否则返回 false；</p><p>②规则二
规则二和规则一之间的策略采用严格连续，要求二者之间不能有其它事件。</p><p>判断 last_page_id 是否为 null，在数据完整有序的前提下，如果不是 null 说明本条日志的页面不是首页，可以断定它与规则一匹配到的事件同属于一个会话，返回 false；</p><p>如果是 null 则开启了一个新的会话，此时可以判定上一条页面日志所属会话为跳出会话，是我们需要的数据，返回 true；</p><p>③超时时间
超时时间内规则一被满足，未等到第二条数据则会被判定为超时数据。</p><p>（3）把匹配规则（Pattern）应用到流上</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">根据 Pattern 定义的规则对流中数据进行筛选。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（4）提取超时流
提取超时流，超时流中满足规则一的数据即为跳出明细数据，取出。</p><p>（5）合并主流和超时流，写入 Kafka 调出明细主题</p><p>（6）结果分析
理论上 Flink 可以通过设置水位线保证数据严格有序（超时时间足够大），在此前提下，同一 mid 的会话之间不会出现交叉。</p><p>若假设日志数据没有丢失，按照上述匹配规则，我们可以获得两类明细数据</p><p>①两个规则都被满足，满足规则一的数据为跳出明细数据。在会话之间不会交叉且日志数据没有丢失的前提下，此时获取的跳出明细数据没有误差；</p><p>②第一条数据满足规则二，超时时间内没有接收到第二条数据，水位线达到超时时间，第一条数据被发送到超时侧输出流。</p><p>即便在会话之间不交叉且日志数据不丢失的前提下，此时获取的跳出明细数据仍有误差，因为超时时间之后会话可能并未结束，如果此时访客在同一会话内跳转到了其它页面，就会导致会话页面数大于 1 的访问被判定为跳出行为，下游计算的跳出率偏大。</p><p>误差大小和设置的超时时间呈负相关关系，超时时间越大，理论上误差越小。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-2">图解<a class="hash-link" href="#图解-2" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242665-cbab2fa8-9aca-4e02-8d09-55111af38e1c.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-2">代码<a class="hash-link" href="#代码-2" title="标题的直接链接">​</a></h3><p>1）添加 CEP 相关依赖</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;flink-cep_${scala.version}&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version&gt;${flink.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.eventtime.WatermarkStrategy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.cep.CEP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.cep.PatternFlatSelectFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.cep.PatternFlatTimeoutFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.cep.PatternStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.cep.pattern.Pattern;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.cep.pattern.conditions.SimpleCondition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.KeyedStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.Collector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.OutputTag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DwdTrafficUserJumpDetail {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(30 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 kafka dwd_traffic_page_log 主题读取日志数据，封装为流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String topic = &quot;dwd_traffic_page_log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String groupId = &quot;dwd_traffic_user_jump_detail&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkKafkaConsumer&lt;String&gt; kafkaConsumer = KafkaUtil.getKafkaConsumer(topic, groupId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStreamSource&lt;String&gt; pageLog = env.addSource(kafkaConsumer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 测试数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*DataStream&lt;String&gt; kafkaDS = env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .fromElements(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;{\&quot;common\&quot;:{\&quot;mid\&quot;:\&quot;101\&quot;},\&quot;page\&quot;:{\&quot;page_id\&quot;:\&quot;home\&quot;},\&quot;ts\&quot;:10000} &quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;{\&quot;common\&quot;:{\&quot;mid\&quot;:\&quot;102\&quot;},\&quot;page\&quot;:{\&quot;page_id\&quot;:\&quot;home\&quot;},\&quot;ts\&quot;:12000}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;{\&quot;common\&quot;:{\&quot;mid\&quot;:\&quot;102\&quot;},\&quot;page\&quot;:{\&quot;page_id\&quot;:\&quot;good_list\&quot;,\&quot;last_page_id\&quot;:&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;\&quot;home\&quot;},\&quot;ts\&quot;:15000} &quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;{\&quot;common\&quot;:{\&quot;mid\&quot;:\&quot;102\&quot;},\&quot;page\&quot;:{\&quot;page_id\&quot;:\&quot;good_list\&quot;,\&quot;last_page_id\&quot;:&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;\&quot;detail\&quot;},\&quot;ts\&quot;:30000} &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 转换结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; mappedStream = pageLog.map(JSON::parseObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 设置水位线，用于用户跳出统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; withWatermarkStream = mappedStream.assignTimestampsAndWatermarks(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                WatermarkStrategy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .&lt;JSONObject&gt;forMonotonousTimestamps()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .withTimestampAssigner(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new SerializableTimestampAssigner&lt;JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    public long extractTimestamp(JSONObject jsonObj, long recordTimestamp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        return jsonObj.getLong(&quot;ts&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 按照 mid 分组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KeyedStream&lt;JSONObject, String&gt; keyedStream = withWatermarkStream.keyBy(jsonOjb -&gt; jsonOjb.getJSONObject(&quot;common&quot;).getString(&quot;mid&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 定义 CEP 匹配规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pattern&lt;JSONObject, JSONObject&gt; pattern = Pattern.&lt;JSONObject&gt;begin(&quot;first&quot;).where(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new SimpleCondition&lt;JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public boolean filter(JSONObject jsonObj) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String lastPageId = jsonObj.getJSONObject(&quot;page&quot;).getString(&quot;last_page_id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return lastPageId == null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ).next(&quot;second&quot;).where(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new SimpleCondition&lt;JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public boolean filter(JSONObject jsonObj) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String lastPageId = jsonObj.getJSONObject(&quot;page&quot;).getString(&quot;last_page_id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return lastPageId == null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 上文调用了同名 Time 类，此处需要使用全类名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ).within(org.apache.flink.streaming.api.windowing.time.Time.seconds(10L));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 把 Pattern 应用到流上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PatternStream&lt;JSONObject&gt; patternStream = CEP.pattern(keyedStream, pattern);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 9. 提取匹配上的事件以及超时事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputTag&lt;JSONObject&gt; timeoutTag = new OutputTag&lt;JSONObject&gt;(&quot;timeoutTag&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;JSONObject&gt; flatSelectStream = patternStream.flatSelect(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                timeoutTag,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new PatternFlatTimeoutFunction&lt;JSONObject, JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void timeout(Map&lt;String, List&lt;JSONObject&gt;&gt; pattern, long timeoutTimestamp, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        JSONObject element = pattern.get(&quot;first&quot;).get(0); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        out.collect(element);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new PatternFlatSelectFunction&lt;JSONObject, JSONObject&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void flatSelect(Map&lt;String, List&lt;JSONObject&gt;&gt; pattern, Collector&lt;JSONObject&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        JSONObject element = pattern.get(&quot;first&quot;).get(0); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        out.collect(element);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;JSONObject&gt; timeOutDStream = flatSelectStream.getSideOutput(timeoutTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 11. 合并两个流并将数据写出到 Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;JSONObject&gt; unionDStream = flatSelectStream.union(timeOutDStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String targetTopic = &quot;dwd_traffic_user_jump_detail&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkKafkaProducer&lt;String&gt; kafkaProducer = KafkaUtil.getKafkaProducer(targetTopic);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          unionDStream .map(JSONAware::toJSONString)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.addSink(kafkaProducer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域加购事务事实表">交易域加购事务事实表<a class="hash-link" href="#交易域加购事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-4">主要任务<a class="hash-link" href="#主要任务-4" title="标题的直接链接">​</a></h3><p>提取加购操作生成加购表，并将字典表中的相关维度退化到加购表中，写出到 Kafka 对应主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-2">思路分析<a class="hash-link" href="#思路分析-2" title="标题的直接链接">​</a></h3><p>1）维度关联（维度退化）实现策略分析</p><p>本章业务事实表的构建全部使用 FlinkSQL 实现，字典表数据存储在 MySQL 的业务数据库中，要做维度退化，就要将这些数据从 MySQL 中提取出来封装成 FlinkSQL 表，Flink 的 JDBC SQL Connector 可以实现我们的需求。</p><p>2）知识储备
（1）JDBC SQL Connector
JDBC 连接器可以让 Flink 程序从拥有 JDBC 驱动的任意关系型数据库中读取数据或将数据写入数据库。</p><p>如果在 Flink SQL 表的 DDL 语句中定义了主键，则会以 upsert 模式将流中数据写入数据库，此时流中可以存在 UPDATE/DElETE（更新/删除）类型的数据。否则，会以 append 模式将数据写出到数据库，此时流中只能有 INSERT（插入）类型的数据。</p><p>DDL 用法实例如下。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE MyUserTable (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name STRING,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age INT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  status BOOLEAN,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (id) NOT ENFORCED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) WITH (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;connector&#x27; = &#x27;jdbc&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;url&#x27; = &#x27;jdbc:mysql://localhost:3306/mydatabase&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;table-name&#x27; = &#x27;users&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（2）Lookup Cache</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">JDBC 连接器可以作为时态表关联中的查询数据源（又称维表）。目前，仅支持同步查询模式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">默认情况下，查询缓存（Lookup Cache）未被启用，需要设置 lookup.cache.max-rows 和 lookup.cache.ttl 参数来启用此功能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lookup 缓存是用来提升有 JDBC 连接器参与的时态关联性能的。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  默认情况下，缓存未启用，所有的请求会被发送到外部数据库。</p><p>  当缓存启用时，每个进程（即 TaskManager）维护一份缓存。收到请求时，Flink 会先查询缓存，如果缓存未命中才会向外部数据库发送请求，并用查询结果更新缓存。</p><p>  如果缓存中的记录条数达到了 lookup.cache.max-rows 规定的最大行数时将清除存活时间最久的记录。</p><p>  如果缓存中的记录存活时间超过了 lookup.cache.ttl 规定的最大存活时间，同样会被清除。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">缓存中的记录未必是最新的，可以将 lookup.cache.ttl 设置为一个更小的值来获得时效性更好的数据，但这样做会增加发送到数据库的请求数量。所以需要在吞吐量和正确性之间寻求平衡。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（3）Lookup Join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lookup Join 通常在 Flink SQL 表和外部系统查询结果关联时使用。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  这种关联要求一张表（主表）有处理时间字段，而另一张表（维表）由 Lookup 连接器生成。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Lookup Join 做的是维度关联，而维度数据是有时效性的，那么我们就需要一个时间字段来对数据的版本进行标识。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  因此，Flink 要求我们提供处理时间用作版本字段。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">此处选择调用 PROCTIME() 函数获取系统时间，将其作为处理时间字段。该函数调用示例如下</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tableEnv.sqlQuery(&quot;select PROCTIME() proc_time&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .execute()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .print();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| op |               proc_time |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| +I | 2022-04-09 15:45:50.752 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">（4）JDBC SQL Connector 参数解读</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>connector：连接器类型，此处为 jdbc</li><li>url：数据库 url</li><li>table-name：数据库中表名</li><li>lookup.cache.max-rows：lookup 缓存中的最大记录条数</li><li>lookup.cache.ttl：lookup 缓存中每条记录的最大存活时间</li><li>username：访问数据库的用户名</li><li>password：访问数据库的密码</li><li>driver：数据库驱动，注意：通常注册驱动可以省略，但是自动获取的驱动是 com.mysql.jdbc.Driver，Flink CDC 2.1.0 要求 mysql 驱动版本必须为 8 及以上，在 mysql-connector -8.x 中该驱动已过时，新的驱动为 com.mysql.cj.jdbc.Driver。省略该参数控制台打印的警告如下
Loading class <code>com.mysql.jdbc.Driver&#x27;. This is deprecated. The new driver class is </code>com.mysql.cj.jdbc.Driver&#x27;. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.<!-- -->  5）Kafka Connector 相关知识需要结合 left join 的实现过程讲解，本节并未涉及 left join。二者将在交易域订单预处理一并介绍。
</li></ul><p>3）执行步骤</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">（1）读取购物车表数据。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  （2）建立 Mysql-LookUp 字典表。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">（3）关联购物车表和字典表，维度退化。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-3">图解<a class="hash-link" href="#图解-3" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242725-1b8b6830-26c8-4a57-87cb-a3493a5f2196.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-3">代码<a class="hash-link" href="#代码-3" title="标题的直接链接">​</a></h3><p>1）补充 Flink SQL 相关依赖</p><p>要执行 Flink SQL 程序，补充相关依赖。JDBC SQL Connector 需要的依赖包含在 Flink CDC 需要的依赖中，不可重复引入。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;flink-table-planner-blink_${scala.version}&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;${flink.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）在 KafkaUtil 中补充 getKafkaDDL 方法和 getUpsertKafkaDDL 方法</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Kafka-Source DDL 语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param topic   数据源主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupId 消费者组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 拼接好的 Kafka 数据源 DDL 语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static String getKafkaDDL(String topic, String groupId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot; with (&#x27;connector&#x27; = &#x27;kafka&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; &#x27;topic&#x27; = &#x27;&quot; + topic + &quot;&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; &#x27;properties.bootstrap.servers&#x27; = &#x27;&quot; + BOOTSTRAP_SERVERS + &quot;&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; &#x27;properties.group.id&#x27; = &#x27;&quot; + groupId + &quot;&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; &#x27;format&#x27; = &#x27;json&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; &#x27;scan.startup.mode&#x27; = &#x27;group-offsets&#x27;)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Kafka-Sink DDL 语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param topic 输出到 Kafka 的目标主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 拼接好的 Kafka-Sink DDL 语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static String getUpsertKafkaDDL(String topic) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;WITH ( &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;  &#x27;connector&#x27; = &#x27;upsert-kafka&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;  &#x27;topic&#x27; = &#x27;&quot; + topic + &quot;&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;  &#x27;properties.bootstrap.servers&#x27; = &#x27;&quot; + BOOTSTRAP_SERVERS + &quot;&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;  &#x27;key.format&#x27; = &#x27;json&#x27;, &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;  &#x27;value.format&#x27; = &#x27;json&#x27; &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）创建 MysqlUtil 工具类</p><p>封装 mysqlLookUpTableDDL() 方法和 getBaesDicLookUpDDL() 方法，用于将 MySQL 数据库中的字典表读取为 Flink LookUp 表，以便维度退化。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.util;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MysqlUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static String getBaseDicLookUpDDL() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;create table `base_dic`(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`dic_code` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`dic_name` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`parent_code` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`create_time` timestamp,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`operate_time` timestamp,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(`dic_code`) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + MysqlUtil.mysqlLookUpTableDDL(&quot;base_dic&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static String mysqlLookUpTableDDL(String tableName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ddl = &quot;WITH (\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;connector&#x27; = &#x27;jdbc&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;url&#x27; = &#x27;jdbc:mysql://hadoop102:3306/gmall&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;table-name&#x27; = &#x27;&quot; + tableName + &quot;&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;lookup.cache.max-rows&#x27; = &#x27;10&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;lookup.cache.ttl&#x27; = &#x27;1 hour&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;username&#x27; = &#x27;root&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;password&#x27; = &#x27;000000&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;&#x27;driver&#x27; = &#x27;com.mysql.cj.jdbc.Driver&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ddl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4）主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.MysqlUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradeCartAdd {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设定 Table 中的时区为本地时区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.getConfig().setLocalTimeZone(ZoneId.of(&quot;GMT+8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table topic_db(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time` as PROCTIME()\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_trade_cart_add&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取购物车表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table cartAdd = tableEnv.sqlQuery(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;source_id&#x27;] source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;source_type&#x27;] source_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;if(`type` = &#x27;insert&#x27;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_num&#x27;],cast((cast(data[&#x27;sku_num&#x27;] as int) - cast(`old`[&#x27;sku_num&#x27;] as int)) as string)) sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;proc_time\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from `topic_db` \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;cart_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and (`type` = &#x27;insert&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;or (`type` = &#x27;update&#x27; \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `old`[&#x27;sku_num&#x27;] is not null \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and cast(data[&#x27;sku_num&#x27;] as int) &gt; cast(`old`[&#x27;sku_num&#x27;] as int)))&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;cart_add&quot;, cartAdd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 建立 MySQL-LookUp 字典表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(MysqlUtil.getBaseDicLookUpDDL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 关联两张表获得加购明细表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;cadd.id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dic_name source_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from cart_add cadd\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join base_dic for system_time as of cadd.proc_time as dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on cadd.source_type=dic.dic_code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 建立 Upsert-Kafka dwd_trade_cart_add 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table dwd_trade_cart_add(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_cart_add&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 将关联结果写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_trade_cart_add select * from result_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域订单预处理表">交易域订单预处理表<a class="hash-link" href="#交易域订单预处理表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-5">主要任务<a class="hash-link" href="#主要任务-5" title="标题的直接链接">​</a></h3><p>经过分析，订单明细表和订单表的数据来源、表结构都相同，差别只在业务过程和过滤条件，为了减少重复计算，将两张表公共的关联过程提取出来，形成订单预处理表。</p><p>关联订单明细表、订单表、订单明细活动关联表、订单明细优惠券关联表四张事实业务表和字典表（维度业务表）形成订单预处理表，写入 Kafka 对应主题。</p><p>本节形成的预处理表中要保留订单表的 type 和 old 字段，用于过滤订单明细数据和取消订单明细数据。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-3">思路分析<a class="hash-link" href="#思路分析-3" title="标题的直接链接">​</a></h3><p>1）知识储备</p><p>（1）left join 实现过程</p><p>假设 A 表作为主表与 B 表做等值左外联。当 A 表数据进入算子，而 B 表数据未至时会先生成一条 B 表字段均为 null 的关联数据ab1，其标记为 +I。</p><p>其后，B 表数据到来，会先将之前的数据撤回，即生成一条与 ab1 内容相同，但标记为 -D 的数据，再生成一条关联后的数据，标记为 +I。这样生成的动态表对应的流称之为回撤流。</p><p>（2）Kafka SQL Connector</p><p>Kafka SQL Connector 分为 Kafka SQL Connector 和 Upsert Kafka SQL Connector</p><p>① 功能
Upsert Kafka Connector支持以 upsert 方式从 Kafka topic 中读写数据
Kafka Connector支持从 Kafka topic 中读写数据</p><p>② 区别</p><p>a）建表语句的主键</p><p>i）Kafka Connector 要求表不能有主键，如果设置了主键，报错信息如下</p><p>Caused by: org.apache.flink.table.api.ValidationException: The Kafka table &#x27;default_catalog.default_database.normal_sink_topic&#x27; with &#x27;json&#x27; format doesn&#x27;t support defining PRIMARY KEY constraint on the table, because it can&#x27;t guarantee the semantic of primary key.
ii）</p><p>而 Upsert Kafka Connector 要求表必须有主键，如果没有设置主键，报错信息如下</p><p>Caused by: org.apache.flink.table.api.ValidationException: &#x27;upsert-kafka&#x27; tables require to define a PRIMARY KEY constraint. The PRIMARY KEY specifies which columns should be read from or write to the Kafka message key. The PRIMARY KEY also defines records in the &#x27;upsert-kafka&#x27; table should update or delete on which keys.
iii）</p><p>语法： primary key(id) not enforced </p><p>注意：not enforced 表示不对来往数据做约束校验，Flink 并不是数据的主人，因此只支持 not enforced 模式</p><p>如果没有 not enforced，报错信息如下</p><p>Exception in thread &quot;main&quot; org.apache.flink.table.api.ValidationException: Flink doesn&#x27;t support ENFORCED mode for PRIMARY KEY constaint. ENFORCED/NOT ENFORCED  controls if the constraint checks are performed on the incoming/outgoing data. Flink does not own the data therefore the only supported mode is the NOT ENFORCED mode</p><p>b）对表中数据操作类型的要求</p><p>i）Kafka Connector 不能消费带有 Upsert/Delete 操作类型数据的表，如 left join 生成的动态表。如果对这类表进行消费，报错信息如下</p><p>Exception in thread &quot;main&quot; org.apache.flink.table.api.TableException: Table sink &#x27;default_catalog.default_database.normal_sink_topic&#x27; doesn&#x27;t support consuming update and delete changes which is produced by node TableSourceScan(table=[<!-- -->[default_catalog, default_database, Unregistered_DataStream_Source_9]<!-- -->], fields=<!-- -->[l_id, tag_left, tag_right]<!-- -->)
ii）</p><p>Upsert Kafka Connector 将 INSERT/UPDATE_AFTER 数据作为正常的 Kafka 消息写入，并将 DELETE 数据以 value 为空的 Kafka 消息写入（表示对应 key 的消息被删除）。</p><p>Flink 将根据主键列的值对数据进行分区，因此同一主键的更新/删除消息将落在同一分区，从而保证同一主键的消息有序。</p><p>③ left join 结合 Upsert Kafka Connector 使用范例</p><p>说明：Kafka 并行度为 4</p><p>a）表结构</p><p>left表
id    tag
A    left
B    left
C    left </p><p>right 表
id    tag
A    right
B    right
C    right</p><p>b）查询语句</p><p>select
l.id l_id,
l.tag l_tag,
r.tag r_tag
from left l
left join
right r
on l.id = r.id</p><p>c）关联结果写入到 Upsert Kafka 表，消费 Kafka 对应主题数据结果展示</p><p>{&quot;l_id&quot;:&quot;A&quot;,&quot;tag_left&quot;:&quot;left&quot;,&quot;tag_right&quot;:null}
null
{&quot;l_id&quot;:&quot;A&quot;,&quot;tag_left&quot;:&quot;left&quot;,&quot;tag_right&quot;:&quot;right&quot;}
{&quot;l_id&quot;:&quot;C&quot;,&quot;tag_left&quot;:&quot;left&quot;,&quot;tag_right&quot;:null}
null
{&quot;l_id&quot;:&quot;C&quot;,&quot;tag_left&quot;:&quot;left&quot;,&quot;tag_right&quot;:&quot;right&quot;}
{&quot;l_id&quot;:&quot;B&quot;,&quot;tag_left&quot;:&quot;left&quot;,&quot;tag_right&quot;:null}
null
{&quot;l_id&quot;:&quot;B&quot;,&quot;tag_left&quot;:&quot;left&quot;,&quot;tag_right&quot;:&quot;right&quot;}</p><p>④ 参数解读
本节需要用到 Kafka 连接器的明细表数据来源于 topic_db 主题，于 Kafka 而言，该主题的数据的操作类型均为 INSERT，所以读取数据使用 Kafka Connector 即可。而由于 left join 的存在，流中存在修改数据，所以写出数据使用 Upsert Kafka Connector。</p><p>a）Kafka Connector 参数</p><ul><li>connector：指定使用的连接器，对于 Kafka，只用 &#x27;kafka&#x27;</li><li>topic：主题</li><li>properties.bootstrap.servers：以逗号分隔的 Kafka broker 列表。注意：可以通过 properties.<em> 的方式指定配置项，</em>的位置用 Kafka 官方规定的配置项的 key 替代。并不是所有的配置都可以通过这种方式配置，因为 Flink 可能会将它们覆盖，如：&#x27;key.deserializer&#x27; 和 &#x27;value.deserializer&#x27;</li><li>properties.group.id：消费者组 ID</li><li>format：指定 Kafka 消息中 value 部分的序列化的反序列化方式，&#x27;format&#x27; 和 &#x27;value.format&#x27; 二者必有其一</li><li>scan.startup.mode：Kafka 消费者启动模式，有四种取值</li><li>&#x27;earliest-offset&#x27;：从偏移量最早的位置开始读取数据</li><li>&#x27;latest-offset&#x27;：从偏移量最新的位置开始读取数据</li><li>&#x27;group-offsets&#x27;：从 Zookeeper/Kafka broker 中维护的消费者组偏移量开始读取数据</li><li>&#x27;timestamp&#x27;：从用户为每个分区提供的时间戳开始读取数据</li><li>&#x27;specific-offsets&#x27;：从用户为每个分区提供的偏移量开始读取数据</li></ul><p>默认值为 group-offsets。要注意：latest-offset 与 Kafka 官方提供的配置项 latest 不同， Flink 会将偏移量置为最新位置，覆盖掉 Zookeeper 或 Kafka 中维护的偏移量。</p><p>与官方提供的 latest 相对应的是此处的 group-offsets。</p><p>b）Upsert Kafka Connector 参数</p><ul><li>connector：指定使用的连接器，对于 Upsert Kafka，使用 &#x27;upsert-kafka&#x27;</li><li>topic：主题</li><li>properties.bootstrap.servers：以逗号分隔的 Kafka broker 列表</li><li>key.format：key 的序列化和反序列化格式</li><li>value.format：value 的序列化和反序列化格式</li></ul><p>2）执行步骤
预处理表与订单明细事务事实表的区别只在于前者不会按照订单数据的 type 和 old 字段做过滤，且在表中增加了这两个字段。二者的粒度、聚合逻辑都相同，因此按照订单明细表的思路对预处理表进行分析即可。</p><p>（1）从 Kafka topic_db 主题读取业务数据；
这一步要调用 PROCTIME() 函数获取系统时间作为与字典表做 Lookup Join 的处理时间字段。</p><p>（2）筛选订单明细表数据；
应尽可能保证事实表的粒度为最细粒度，在下单业务过程中，最细粒度的事件为一个订单的一个 SKU 的下单操作，订单明细表的粒度与最细粒度相同，将其作为主表。</p><p>（3）筛选订单表数据；
通过该表获取 user_id 和 province_id。保留 type 字段和 old 字段用于过滤订单明细数据和取消订单明细数据。</p><p>（4）筛选订单明细活动关联表数据；
通过该表获取活动 id 和活动规则 id。</p><p>（5）筛选订单明细优惠券关联表数据；
通过该表获取优惠券 id。</p><p>（6）建立 MySQL-Lookup 字典表；
通过字典表获取订单来源类型名称。</p><p>（7）关联上述五张表获得订单宽表，写入 Kafka 主题
主表与其余四张表的关联都为了获取维度信息，使用左外连接即可。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-4">图解<a class="hash-link" href="#图解-4" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242778-9c825356-7b33-4916-a436-fdc6475d9f1e.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-4">代码<a class="hash-link" href="#代码-4" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.MysqlUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradeOrderPreProcess {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 启用状态后端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RestartStrategies.failureRateRestart(3, Time.days(1L), Time.minutes(3L))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.getConfig().setLocalTimeZone(ZoneId.of(&quot;GMT+8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` String,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` String,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` String,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;String, String&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;String, String&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time` as PROCTIME(),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_trade_order_pre_process&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取订单明细表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderDetail = tableEnv.sqlQuery(&quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_name&#x27;] sku_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;create_time&#x27;] create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;source_id&#x27;] source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;source_type&#x27;] source_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_num&#x27;] sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;cast(cast(data[&#x27;sku_num&#x27;] as decimal(16,2)) * &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;cast(data[&#x27;order_price&#x27;] as decimal(16,2)) as String) split_original_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;split_total_amount&#x27;] split_total_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;split_activity_amount&#x27;] split_activity_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;split_coupon_amount&#x27;] split_coupon_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts od_ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;proc_time\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from `topic_db` where `table` = &#x27;order_detail&#x27; &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_detail&quot;, orderDetail);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 读取订单表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderInfo = tableEnv.sqlQuery(&quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;province_id&#x27;] province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;operate_time&#x27;] operate_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_status&#x27;] order_status,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type`,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old`,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts oi_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from `topic_db`\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;order_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and (`type` = &#x27;insert&#x27; or `type` = &#x27;update&#x27;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_info&quot;, orderInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 读取订单明细活动关联表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderDetailActivity = tableEnv.sqlQuery(&quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_detail_id&#x27;] order_detail_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;activity_id&#x27;] activity_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;activity_rule_id&#x27;] activity_rule_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from `topic_db`\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;order_detail_activity&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_detail_activity&quot;, orderDetailActivity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 读取订单明细优惠券关联表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderDetailCoupon = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_detail_id&#x27;] order_detail_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;coupon_id&#x27;] coupon_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from `topic_db`\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;order_detail_coupon&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_detail_coupon&quot;, orderDetailCoupon);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 建立 MySQL-LookUp 字典表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(MysqlUtil.getBaseDicLookUpDDL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 9. 关联五张表获得订单明细表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.order_status,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.sku_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;act.activity_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;act.activity_rule_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;cou.coupon_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(od.create_time, &#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(oi.operate_time, &#x27;yyyy-MM-dd&#x27;) operate_date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.operate_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.source_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dic.dic_name source_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_original_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_activity_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_coupon_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_total_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.`type`,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.`old`,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.od_ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.oi_ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;current_row_timestamp() row_op_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from order_detail od \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;join order_info oi\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on od.order_id = oi.id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join order_detail_activity act\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on od.id = act.order_detail_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join order_detail_coupon cou\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on od.id = cou.order_detail_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join `base_dic` for system_time as of od.proc_time as dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on od.source_type = dic.dic_code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 10. 建立 Upsert-Kafka dwd_trade_order_pre_process 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table dwd_trade_order_pre_process(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_status string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;string,string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od_ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi_ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_order_pre_process&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 11. 将关联结果写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_trade_order_pre_process \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select * from result_table&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .print();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域下单事务事实表">交易域下单事务事实表<a class="hash-link" href="#交易域下单事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-6">主要任务<a class="hash-link" href="#主要任务-6" title="标题的直接链接">​</a></h3><p>从 Kafka 读取订单预处理表数据，筛选订单明细数据，写入 Kafka 对应主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-4">思路分析<a class="hash-link" href="#思路分析-4" title="标题的直接链接">​</a></h3><p>实现步骤</p><p>（1）从 Kafka dwd_trade_order_pre_process 主题读取订单预处理数据；</p><p>（2）筛选订单明细数据：新增数据，即订单表操作类型为 insert 的数据即为订单明细数据；</p><p>（3）写入 Kafka 订单明细主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-5">图解<a class="hash-link" href="#图解-5" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242807-36dcfafa-0ea0-4ee0-b3c9-e076a5b343a0.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-5">代码<a class="hash-link" href="#代码-5" title="标题的直接链接">​</a></h3><p>主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradeOrderDetail {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 启用状态后端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RestartStrategies.failureRateRestart(3, Time.days(1L), Time.minutes(3L))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.getConfig().setLocalTimeZone(ZoneId.of(&quot;GMT+8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 读取 Kafka dwd_trade_order_pre_process 主题数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table dwd_trade_order_pre_process(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_status string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;string,string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od_ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi_ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3)\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dwd_trade_order_pre_process&quot;, &quot;dwd_trade_order_detail&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 过滤下单数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table filteredTable = tableEnv.sqlQuery(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type source_type_code,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od_ts ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from dwd_trade_order_pre_process &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `type`=&#x27;insert&#x27;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;filtered_table&quot;, filteredTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 创建 Kafka 下单明细表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table dwd_trade_order_detail(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_order_detail&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 将数据写出到 Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;insert into dwd_trade_order_detail select * from filtered_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域取消订单事务事实表">交易域取消订单事务事实表<a class="hash-link" href="#交易域取消订单事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-7">主要任务<a class="hash-link" href="#主要任务-7" title="标题的直接链接">​</a></h3><p>从 Kafka 读取订单预处理表数据，筛选取消订单明细数据，写入 Kafka 对应主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-5">思路分析<a class="hash-link" href="#思路分析-5" title="标题的直接链接">​</a></h3><p>实现步骤</p><p>（1）从 Kafka dwd_trade_order_pre_process 主题读取订单预处理数据；</p><p>（2）筛选取消订单明细数据：保留修改了 order_status 字段且修改后该字段值为 &quot;1003&quot; 的数据;</p><p>（3）写入 Kafka 取消订单主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-6">图解<a class="hash-link" href="#图解-6" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242824-aeb7b7b9-afb7-407e-b5ab-3bd377c577e1.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-6">代码<a class="hash-link" href="#代码-6" title="标题的直接链接">​</a></h3><p>主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradeCancelDetail  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 启用状态后端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RestartStrategies.failureRateRestart(3, Time.days(1L), Time.minutes(3L))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.getConfig().setLocalTimeZone(ZoneId.of(&quot;GMT+8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 读取 Kafka dwd_trade_order_pre_process 主题数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table dwd_trade_order_pre_process(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_status string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;string,string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od_ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi_ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3)\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;dwd_trade_order_pre_process&quot;, &quot;dwd_trade_cancel_detail&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 筛选取消订单明细数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table filteredTable = tableEnv.sqlQuery(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_date_id date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;operate_time cancel_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type source_type_code,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi_ts ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from dwd_trade_order_pre_process\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `type` = &#x27;update&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `old`[&#x27;order_status&#x27;] is not null\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and order_status = &#x27;1003&#x27;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;filtered_table&quot;, filteredTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 建立 Upsert-Kafka dwd_trade_cancel_detail 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_trade_cancel_detail(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;cancel_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_cancel_detail&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 将数据写出到 Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_trade_cancel_detail select * from filtered_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域支付成功事务事实表">交易域支付成功事务事实表<a class="hash-link" href="#交易域支付成功事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-8">主要任务<a class="hash-link" href="#主要任务-8" title="标题的直接链接">​</a></h3><p>从 Kafka topic_db主题筛选支付成功数据、从dwd_trade_order_detail主题中读取订单事实数据、MySQL-LookUp字典表，关联三张表形成支付成功宽表，写入 Kafka 支付成功主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-6">思路分析<a class="hash-link" href="#思路分析-6" title="标题的直接链接">​</a></h3><p>1）获取订单明细数据</p><p>用户必然要先下单才有可能支付成功，因此支付成功明细数据集必然是订单明细数据集的子集。</p><p>2）筛选支付表数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">获取支付类型、回调时间（支付成功时间）、支付成功时间戳。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">生产环境下，用户支付后，业务数据库的支付表会插入一条数据，此时的回调时间和回调内容为空。通常底层会调用第三方支付接口，接口会返回回调信息，如果支付成功则回调信息不为空，此时会更新支付表，补全回调时间和回调内容字段的值，并将 payment_status 字段的值修改为支付成功对应的状态码（本项目为 1602）。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  支付成功之后，支付表数据不会发生变化。因此，只要操作类型为 update 且状态码为 1602 即为支付成功数据。</p><p>由上述分析可知，支付成功对应的业务数据库变化日志应满足两个条件：</p><p>（1）payment_status 字段的值为 1602；</p><p>（2）操作类型为 update。</p><p>注：1602 在字典表中并没有对应记录，且 payment_info 中 payment_status 字段的值均为 null，这是模拟数据的问题，并不影响业务逻辑，无须深究。</p><p>为了看到效果，注释对条件（1）的判断。</p><p>此外，模拟的 payment_info 表数据没有上述提到的变化，只在支付成功时插入一条数据，此时的 callback_time 字段值已经不为 null，即该表中的所有数据均为支付成功数据。</p><p>为了看到效果，注释对条件（2）的判断。</p><p>本程序为了去除重复数据，在关联后的宽表中补充了处理时间字段，DWS 层将进行详细介绍。</p><p>支付成功表是由支付成功数据与订单明细做内连接，而后与字典表做 LookUp Join 得来。</p><p>这个过程中不会出现回撤数据，关联后表的重复数据来源于订单明细表，所以应按照订单明细表的处理时间字段去重，故支付成功明细表的 row_op_ts 取自订单明细表。</p><p>3）构建 MySQL-LookUp 字典表</p><p>4）关联上述三张表形成支付成功宽表，写入 Kafka 支付成功主题</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-7">图解<a class="hash-link" href="#图解-7" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242855-0d3f0e7c-68d8-4445-ba81-d75ea6da16a1.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-7">代码<a class="hash-link" href="#代码-7" title="标题的直接链接">​</a></h3><p>主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.MysqlUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradePayDetailSuc {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 基本环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.getConfig().setLocalTimeZone(ZoneId.of(&quot;GMT+8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 读取 Kafka dwd_trade_order_detail 主题数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create table dwd_trade_order_detail(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_total_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3)\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;dwd_trade_order_detail&quot;, &quot;dwd_trade_pay_detail_suc&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` String,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` String,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` String,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;String, String&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;String, String&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time` as PROCTIME(),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_trade_pay_detail_suc&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 筛选支付成功数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table paymentInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;payment_type&#x27;] payment_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;callback_time&#x27;] callback_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time`,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;payment_info&#x27;\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;and `type` = &#x27;update&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;and data[&#x27;payment_status&#x27;]=&#x27;1602&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;payment_info&quot;, paymentInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 建立 MySQL-LookUp 字典表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(MysqlUtil.getBaseDicLookUpDDL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 关联 3 张表获得支付成功宽表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.id order_detail_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.sku_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.activity_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.activity_rule_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.coupon_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;pi.payment_type payment_type_code,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dic.dic_name payment_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;pi.callback_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.source_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.source_type_code,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.source_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.sku_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_original_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_activity_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_coupon_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.split_total_amount split_payment_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;pi.ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;od.row_op_ts row_op_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from payment_info pi\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;join dwd_trade_order_detail od\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on pi.order_id = od.order_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join `base_dic` for system_time as of pi.proc_time as dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on pi.payment_type = dic.dic_code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 创建 Kafka dwd_trade_pay_detail 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_trade_pay_detail_suc(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_detail_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;activity_rule_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;payment_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;payment_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;callback_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;source_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_original_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_activity_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_coupon_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;split_payment_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(order_detail_id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_pay_detail_suc&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 9. 将关联结果写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_trade_pay_detail_suc select * from result_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域退单事务事实表">交易域退单事务事实表<a class="hash-link" href="#交易域退单事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-9">主要任务<a class="hash-link" href="#主要任务-9" title="标题的直接链接">​</a></h3><p>从 Kafka 读取业务数据，筛选退单表数据，筛选满足条件的订单表数据，建立 MySQL-Lookup 字典表，关联三张表获得退单明细宽表。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-7">思路分析<a class="hash-link" href="#思路分析-7" title="标题的直接链接">​</a></h3><p>1）筛选退单表数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">退单业务过程最细粒度的操作为一个订单中一个 SKU 的退单操作，退单表粒度与最细粒度相同，将其作为主表。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）筛选订单表数据并转化为流</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">获取 province_id。退单操作发生时，订单表的 order_status 字段值会由1002（已支付）更新为 1005（退款中）。订单表中的数据要满足三个条件：</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（1）order_status 为 1005（退款中）；</p><p>（2）操作类型为 update；</p><p>（3）更新的字段为 order_status。</p><p>该字段发生变化时，变更数据中 old 字段下 order_status 的值不为 null（为 1002）。</p><p>3）建立 MySQL-Lookup 字典表</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">获取退款类型名称和退款原因类型名称。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4）关联这几张表获得退单明细宽表，写入 Kafka 退单明细主题</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">主表中的数据都与退单业务相关，因此所有关联均用左外联即可。第二步是否对订单表数据筛选并不影响查询结果，提前对数据进行过滤是为了减少数据量，减少性能消耗。下文同理，不再赘述。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-8">图解<a class="hash-link" href="#图解-8" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242887-d9848372-5e23-4e3e-9737-472fa67d50c4.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-8">代码<a class="hash-link" href="#代码-8" title="标题的直接链接">​</a></h3><p>主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.MysqlUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradeOrderRefund {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取 topic_db 数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time` as PROCTIME(),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_trade_order_refund&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取退单表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderRefundInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;refund_type&#x27;] refund_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;refund_num&#x27;] refund_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;refund_amount&#x27;] refund_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;refund_reason_type&#x27;] refund_reason_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;refund_reason_txt&#x27;] refund_reason_txt,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;create_time&#x27;] create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;proc_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;order_refund_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_refund_info&quot;, orderRefundInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 读取订单表数据，筛选退单数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderInfoRefund = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;province_id&#x27;] province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old`\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;order_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;update&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and data[&#x27;order_status&#x27;]=&#x27;1005&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `old`[&#x27;order_status&#x27;] is not null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_info_refund&quot;, orderInfoRefund);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 建立 MySQL-LookUp 字典表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(MysqlUtil.getBaseDicLookUpDDL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 关联三张表获得退单宽表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(ri.create_time,&#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.refund_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type_dic.dic_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.refund_reason_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;reason_dic.dic_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.refund_reason_txt,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.refund_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.refund_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;current_row_timestamp() row_op_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from order_refund_info ri\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_info_refund oi\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on ri.order_id = oi.id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;base_dic for system_time as of ri.proc_time as type_dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on ri.refund_type = type_dic.dic_code\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;base_dic for system_time as of ri.proc_time as reason_dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on ri.refund_reason_type=reason_dic.dic_code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 建立 Upsert-Kafka dwd_trade_order_refund 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_trade_order_refund(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_reason_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_reason_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_reason_txt string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_order_refund&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 9. 将关联结果写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_trade_order_refund select * from result_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="交易域退款成功事务事实表">交易域退款成功事务事实表<a class="hash-link" href="#交易域退款成功事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-10">主要任务<a class="hash-link" href="#主要任务-10" title="标题的直接链接">​</a></h3><p>1）从退款表中提取退款成功数据，并将字典表的 dic_name 维度退化到表中</p><p>2）从订单表中提取退款成功订单数据</p><p>3）从退单表中提取退款成功的明细数据</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-8">思路分析<a class="hash-link" href="#思路分析-8" title="标题的直接链接">​</a></h3><p>1）建立 MySQL-Lookup 字典表</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">获取支付类型名称。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）读取退款表数据，筛选退款成功数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">退款表 refund_payment 的粒度为一个订单中一个 SKU 的退款记录，与退款业务过程的最细粒度相同，将其作为主表。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">退款操作发生时，业务数据库的退款表会先插入一条数据，此时 refund_status 状态码应为 0701（商家审核中），callback_time 为 null，而后经历一系列业务过程：商家审核、买家发货、退单完成。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  退单完成时会将状态码由 0701 更新为 0705（退单完成），同时将 callback_time 更新为退款支付成功的回调时间。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">由上述分析可知，退款成功记录应满足三个条件：</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  （1）数据操作类型为 update；</p><p>  （2）refund_status 为 0705；</p><p>  （3）修改的字段包含 refund_status。</p><p>注：本项目生成模拟数据的字典表中并没有与退单状态相关的状态码记录，且退款表的数据并没有上述分析提到的完整业务流程中多业务过程的变化，仅在退款操作完成时插入一条数据，此时的 refund_status 为 0702，callback_time 不为 null，因此要想观测到查询效果，查询条件应做修改：</p><p>（1）注释对操作类型的判断；</p><p>（2）where 子句中 refund_status 的值应为 0702；</p><p>（3）该条件的校验是通过判断 old<!-- -->[&#x27;refund_status&#x27;]<!-- --> 的值是否为 null 来实现的，模拟数据没有修改，old<!-- -->[&#x27;refund_status&#x27;]<!-- --> 必为 null，需要注释该条件。</p><p>模拟数据生成的问题并不影响我们对业务逻辑的分析，无须在意。</p><p>3）读取订单表数据，过滤退款成功订单数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">用于获取 user_id 和 province_id。退款操作完后时，订单表的 order_status 字段会更新为 1006（退款完成），因此退单成功对应的订单数据应满足三个条件：</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（1）操作类型为 update；</p><p>（2）order_status 为 1006；（3）修改了 order_status 字段。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">order_status 值更改为 1006 之后对应的订单表数据就不会再发生变化，所以只要满足前两个条件，第三个条件必定满足。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  本项目 order_info 表并没有退款成功时应有的变化，没有 order_status 取值为 1006 的记录。</p><p>  为了看到效果注释掉所有过滤条件。order_info 表的关联是为了获取 user_id 和 province_id，没有过滤条件会把 order_info 表的所有变更操作保留，可能会导致数据重复，但下游会进行去重，不会影响最终结果。</p><p>4）筛选退款成功的退单明细数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">用于获取退单件数 refund_num。退单成功时 order_refund_info 表中的 refund_status 字段会修改为0705（退款成功状态码）。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  因此筛选条件有三：</p><p>  （1）操作类型为 update；</p><p>  （2）refund_status 为 0705；</p><p>  （3）修改了 refund_status 字段。筛选方式同上。</p><p>注：本项目模拟数据的字典表并未维护退单相关的状态码（暂未发布的数据生成文件补充了相关状态码，退款成功状态码为 0705）。</p><p>当前业务数据库中 order_refund_info 表所有记录的 refund_status 字段值均为 null。</p><p>此外，order_refund_info 表只有 insert 操作，即模拟数据的业务逻辑是退单操作和退款完成同时发生。</p><p>因此要想看到效果，需要对过滤条件做特殊处理：</p><p>（1）注释对 refund_status 的判断；</p><p>（2）注释对操作类型的判断；</p><p>（3）注释对修改字段的判断。</p><p>5）关联四张表并写出到 Kafka 退款成功主题</p><p>主表数据筛选完成后已经获取了全部、准确的退款成功数据，与另外两张表的关联只是为了补充字段，因此使用 left join 即可。之所以提前过滤是为了减小数据量，提升计算效率。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-9">图解<a class="hash-link" href="#图解-9" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242919-007d7af2-34bf-4be2-b9c8-a11f87814317.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-9">代码<a class="hash-link" href="#代码-9" title="标题的直接链接">​</a></h3><p>主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.MysqlUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdTradeRefundPaySuc {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取 topic_db 数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time` as PROCTIME(),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_trade_refund_pay_suc&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 建立 MySQL-LookUp 字典表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(MysqlUtil.getBaseDicLookUpDDL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 读取退款表数据，并筛选退款成功数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table refundPayment = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;payment_type&#x27;] payment_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;callback_time&#x27;] callback_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;total_amount&#x27;] total_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;proc_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;where `table` = &#x27;refund_payment&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;and `type` = &#x27;update&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;and data[&#x27;refund_status&#x27;] = &#x27;0702&#x27;\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                        +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;and `old`[&#x27;refund_status&#x27;] is not null&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;refund_payment&quot;, refundPayment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 读取订单表数据并过滤退款成功订单数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;province_id&#x27;] province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old`\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;order_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;update&#x27;\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;and data[&#x27;order_status&#x27;]=&#x27;1006&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;and `old`[&#x27;order_status&#x27;] is not null&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_info&quot;, orderInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 读取退单表数据并过滤退款成功数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table orderRefundInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;data[&#x27;refund_num&#x27;] refund_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;`old`\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;where `table` = &#x27;order_refund_info&#x27;\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                        +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                        &quot;and `type` = &#x27;update&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                        &quot;and data[&#x27;refund_status&#x27;]=&#x27;0705&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                        &quot;and `old`[&#x27;refund_status&#x27;] is not null&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // order_refund_info 表的 refund_status 字段值均为 null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;order_refund_info&quot;, orderRefundInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 关联四张表获得退款成功表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;oi.province_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.payment_type,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dic.dic_name payment_type_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(rp.callback_time,&#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.callback_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ri.refund_num,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.total_amount,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;rp.ts,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;current_row_timestamp() row_op_ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from refund_payment rp \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_info oi\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on rp.order_id = oi.id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_refund_info ri\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on rp.order_id = ri.order_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and rp.sku_id = ri.sku_id\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;base_dic for system_time as of rp.proc_time as dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on rp.payment_type = dic.dic_code\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 9. 创建 Upsert-Kafka dwd_trade_refund_pay_suc 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_trade_refund_pay_suc(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;province_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;payment_type_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;payment_type_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;callback_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_num string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;refund_amount string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;row_op_ts timestamp_ltz(3),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_trade_refund_pay_suc&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 10. 将关联结果写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_trade_refund_pay_suc select * from result_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具域优惠券领取事务事实表">工具域优惠券领取事务事实表<a class="hash-link" href="#工具域优惠券领取事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-11">主要任务<a class="hash-link" href="#主要任务-11" title="标题的直接链接">​</a></h3><p>读取优惠券领用数据，写入 Kafka 优惠券领用主题</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-9">思路分析<a class="hash-link" href="#思路分析-9" title="标题的直接链接">​</a></h3><p>用户领取优惠券后，业务数据库的优惠券领用表会新增一条数据，因此操作类型为 insert 的数据即为优惠券领取数据。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-10">图解<a class="hash-link" href="#图解-10" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242954-7fe50475-454e-40a1-a871-d41039e98830.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-10">代码<a class="hash-link" href="#代码-10" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdToolCouponGet {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table `topic_db`(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_tool_coupon_get&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取优惠券领用数据，封装为表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;],\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;coupon_id&#x27;],\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;],\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(data[&#x27;get_time&#x27;],&#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;get_time&#x27;],\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;coupon_use&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 建立 Upsert-Kafka dwd_tool_coupon_get 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_tool_coupon_get (\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;get_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_tool_coupon_get&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 将数据写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_tool_coupon_get select * from result_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具域优惠券使用下单事务事实表">工具域优惠券使用（下单）事务事实表<a class="hash-link" href="#工具域优惠券使用下单事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-12">主要任务<a class="hash-link" href="#主要任务-12" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">读取优惠券领用表数据，筛选优惠券下单数据，写入 Kafka 优惠券下单主题。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-10">思路分析<a class="hash-link" href="#思路分析-10" title="标题的直接链接">​</a></h3><p>1）知识储备
用户使用优惠券下单时，优惠券领用表的 using_time 字段会更新为下单时间，因此优惠券下单数据应满足两个条件：</p><p>① 操作类型为 update；</p><p>② 修改了 using_time 字段。</p><p>① 条件一的判断非常简单，只须在 SQL 语句中补充 where 条件；</p><p>② 条件二需要判断 Maxwell 封装的 JSON 字符串中 <code>old</code> 字段下是否有 using_time 字段，<code>old</code> 字段的数据类型是 Map，它的 key 是发生变更的字段名称，value 是字段旧值。</p><p>在离线数仓中我们将 Maxwell 封装的 JSON 字符串定义为 HIVE 表中的结构体字段，用 map_keys() 函数获取了所有的 key，该函数的返回值是个 array（数组），数组中保存了所有发生变更的字段名称，最后用 array_contains() 方法判断该数组中是否包含 order_status 字段即可完成条件二的判断。</p><p>而 Flink SQL 并没有提供类似的 API，我们无法获取发生变更的字段名称。</p><p>所以需要换一种思路，此处将 Flink SQL 动态表转化为流，通过流处理筛选满足条件二的数据，再将流转换为动态表。此处涉及流和动态表的转化，我们有必要先了解相关 API。</p><p>（1）环境准备</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">业务场景：left、right 两张表做 left join，然后将获取的 Table 类型变量（动态表）转换为流，再将流转换为 Table 变量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">① left、right 表如下</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>left表</p><p>id    tag
A    left
B    left
C    left </p><p>right 表</p><p>id    tag
A    right
B    right
C    right</p><p>② SQL 如下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Table joinTable = tableEnv.sqlQuery(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;l.id l_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;l.tag l_tag,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;r.tag r_tag\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;from left l \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;left join \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;right r \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;on l.id = r.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>③ 实体类 JoinBean 如下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JoinBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String l_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String tag_left;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String tag_right;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（2）Flink SQL 的 Table 类型变量转化为 DataStream 有四类 API</p><p>① toAppendStream</p><p>② toDataStream</p><p>③ toChangelogStream</p><p>④ toRetractStream</p><p>其中，Table 变量中包含更新和删除数据时调用 ① 和 ② 转化为流会报错，报错信息如下</p><p>// toAppendStream 报错信息</p><p>toAppendStream doesn&#x27;t support consuming update and delete changes which is produced by node Join(joinType=<!-- -->[LeftOuterJoin]<!-- -->, where=<!-- -->[(id = id0)]<!-- -->, select=<!-- -->[id, tag, id0, tag0]<!-- -->, leftInputSpec=<!-- -->[NoUniqueKey]<!-- -->, rightInputSpec=<!-- -->[NoUniqueKey]<!-- -->)</p><p>// toDataStream 报错信息</p><p>Table sink &#x27;default_catalog.default_database.Unregistered_DataStream_Sink_2&#x27; doesn&#x27;t support consuming update and delete changes which is produced by node Join(joinType=<!-- -->[LeftOuterJoin]<!-- -->, where=<!-- -->[(id = id0)]<!-- -->, select=<!-- -->[id, tag, id0, tag0]<!-- -->, leftInputSpec=<!-- -->[NoUniqueKey]<!-- -->, rightInputSpec=<!-- -->[NoUniqueKey]<!-- -->)</p><p>调用 ③ 和 ④ 可以将包含更新和删除数据的表转化为流。需要指定表结构时用法如下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;Row&gt; changelogStream = tableEnv.toChangelogStream(joinTable, Schema.newBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .column(&quot;l_id&quot;, &quot;STRING&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .column(&quot;tag_left&quot;, &quot;STRING&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .column(&quot;tag_right&quot;, &quot;STRING&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.build());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;Tuple2&lt;Boolean, JoinBean&gt;&gt; retractS = tableEnv.toRetractStream(joinTable, JoinBean.class); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream.print(&quot;changelogStream&gt;&gt;&gt;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS.print(&quot;retractS&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>流打印结果如下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; +I[A, left, null]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; -D[A, left, null]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; +I[A, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; +I[B, left, null]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; -D[B, left, null]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; +I[B, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; +I[C, left, null]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; -D[C, left, null]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream&gt;&gt;&gt;&gt; +I[C, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (true,JoinBean(l_id=A, tag_left=left, tag_right=null))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (false,JoinBean(l_id=A, tag_left=left, tag_right=null))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (true,JoinBean(l_id=A, tag_left=left, tag_right=right))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (true,JoinBean(l_id=B, tag_left=left, tag_right=null))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (false,JoinBean(l_id=B, tag_left=left, tag_right=null))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (true,JoinBean(l_id=B, tag_left=left, tag_right=right))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (true,JoinBean(l_id=C, tag_left=left, tag_right=null))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (false,JoinBean(l_id=C, tag_left=left, tag_right=null))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retractS&gt; (true,JoinBean(l_id=C, tag_left=left, tag_right=right))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（3）将流转化为动态表</p><p>① 目前版本 Flink 只提供了两种 API </p><ul><li>fromChangelogStream</li><li>fromDataStream</li></ul><p>② 应用场景</p><p>a）fromDataStream 不可用于包含删除和更新数据的流向 Table 的转化，否则报错，报错信息如下</p><p>Error during input conversion. Conversion expects insert-only records but DataStream API record contains: DELETE</p><p>b）fromChangelogStream 可用于包含删除和更新数据流向 Table 的转化</p><p>③ 用法</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Table changelogTable = tableEnv.fromChangelogStream(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changelogStream,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Schema.newBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .column(&quot;l_id&quot;, &quot;STRING&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .column(&quot;tag_left&quot;, &quot;STRING&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .column(&quot;tag_right&quot;, &quot;STRING&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（4）本项目 DWD 层涉及到的流和表转化</p><p>INSERT 操作的流和表没有回撤数据，不需要考虑去重问题。</p><p>① 从 Kafka 读取的 ODS 层数据操作类型均为 INSERT；</p><p>② 只含 INSERT 操作的数据和 Lookup 表关联后的数据同样只有 INSERT 操作</p><p>所以，本项目中流和表的转化不用考虑去重，无须额外处理。</p><p>2）执行步骤
（1）筛选优惠券领用数据封装为表。</p><p>筛选操作类型为 update 的数据。</p><p>（2）在流中筛选优惠券领取数据。</p><p>判断是否修改了 using_time 字段。</p><p>（3）封装为表，写入 Kafka 优惠券使用（下单）事实主题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-11">图解<a class="hash-link" href="#图解-11" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242981-19c9ef18-45a2-4d94-8d1f-ac529014bb35.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-11">代码<a class="hash-link" href="#代码-11" title="标题的直接链接">​</a></h3><p>1）创建实体类 CouponUseOrderBean</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CouponUseOrderBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 优惠券领用记录 id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 优惠券 id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String coupon_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 用户 id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String user_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订单 id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String order_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 优惠券使用日期（下单）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String date_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 优惠券使用时间（下单）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String using_time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 历史数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String old;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 时间戳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）主程序</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">com</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">atguigu</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">gmall</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">realtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">app</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">dwd</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">db</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">alibaba</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">fastjson</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">JSON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">atguigu</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">gmall</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">realtime</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">bean</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">CouponUseOrderBean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">atguigu</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">gmall</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">realtime</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">KafkaUtil</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">common</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">restartstrategy</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">RestartStrategies</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">common</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">time</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Time</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">runtime</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">state</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">hashmap</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">HashMapStateBackend</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">streaming</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">CheckpointingMode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">streaming</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">datastream</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">DataStream</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">streaming</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">datastream</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">SingleOutputStreamOperator</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">streaming</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">environment</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">CheckpointConfig</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">streaming</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">environment</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">StreamExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">table</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">flink</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">table</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">bridge</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">StreamTableEnvironment</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Map</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Set</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DwdToolCouponOrder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 1. 环境准备</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">StreamExecutionEnvironment</span><span class="token plain"> env </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setParallelism</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">StreamTableEnvironment</span><span class="token plain"> tableEnv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 2. 状态后端设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableCheckpointing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">CheckpointingMode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">EXACTLY_ONCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCheckpointConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCheckpointTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCheckpointConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setMinPauseBetweenCheckpoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCheckpointConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableExternalizedCheckpoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">CheckpointConfig</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">ExternalizedCheckpointCleanup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RETAIN_ON_CANCELLATION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRestartStrategy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RestartStrategies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">failureRateRestart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">days</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">minutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setStateBackend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HashMapStateBackend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCheckpointConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCheckpointStorage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;hdfs://hadoop102:8020/ck&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;atguigu&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeSql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;create table `topic_db` (\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;`database` string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;`table` string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;`data` map&lt;string, string&gt;,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;`type` string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;`old` string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;`ts` string\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;)&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">KafkaUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getKafkaDDL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;topic_db&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dwd_tool_coupon_order&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 4. 读取优惠券领用表数据，封装为流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Table</span><span class="token plain"> couponUseOrder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sqlQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                select</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                data[&#x27;id&#x27;] id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                data[&#x27;coupon_id&#x27;] coupon_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                data[&#x27;user_id&#x27;] user_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                data[&#x27;order_id&#x27;] order_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                date_format(data[&#x27;using_time&#x27;],&#x27;yyyy-MM-dd&#x27;) date_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                data[&#x27;using_time&#x27;] using_time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                `old`,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                from topic_db</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                where `table` = &#x27;coupon_use&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                and `type` = &#x27;update&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                &quot;&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">DataStream</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">CouponUseOrderBean</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> couponUseOrderDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toAppendStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">couponUseOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">CouponUseOrderBean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 5. 过滤满足条件的优惠券下单数据，封装为表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SingleOutputStreamOperator</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">CouponUseOrderBean</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> filteredDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> couponUseOrderDS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                couponUseOrderBean </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">String</span><span class="token plain"> old </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> couponUseOrderBean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">old </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Map</span><span class="token plain"> oldMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parseObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">old</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Set</span><span class="token plain"> changeKeys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keySet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> changeKeys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;using_time&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Table</span><span class="token plain"> resultTable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromDataStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filteredDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createTemporaryView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;result_table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultTable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 6. 建立 Upsert-Kafka dwd_tool_coupon_order 表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeSql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;create table dwd_tool_coupon_order(\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;id string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;coupon_id string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;user_id string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;order_id string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;date_id string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;order_time string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;ts string,\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;primary key(id) not enforced\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;)&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">KafkaUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUpsertKafkaDDL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;dwd_tool_coupon_order&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 7. 将数据写入 Upsert-Kafka 表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeSql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                insert into dwd_tool_coupon_order select id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                coupon_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                user_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                order_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                date_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                using_time order_time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                ts from result_table&quot;&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具域优惠券使用支付事务事实表">工具域优惠券使用(支付)事务事实表<a class="hash-link" href="#工具域优惠券使用支付事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-13">主要任务<a class="hash-link" href="#主要任务-13" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">读取优惠券领用表数据，筛选优惠券支付数据，写入 Kafka 优惠券支付主题。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-11">思路分析<a class="hash-link" href="#思路分析-11" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">用户使用优惠券支付时，优惠券领用表的 used_time 字段会更新为支付时间，因此优惠券支付数据应满足两个条件：</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  （1）操作类型为 update；</p><p>  （2）修改了 used_time 字段。使用优惠券支付后，优惠券领用表数据就不会再发生变化，所以在操作类型为 update 的前提下，只要 used_time 不为 null，就可以断定本次操作修改的是 used_time 字段。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-12">图解<a class="hash-link" href="#图解-12" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167242998-8443ee23-a92f-4581-98a3-5d50a8b83edf.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-12">代码<a class="hash-link" href="#代码-12" title="标题的直接链接">​</a></h3><p>主程序</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdToolCouponPay {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table `topic_db` (\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_tool_coupon_pay&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取优惠券领用表数据，筛选优惠券使用（支付）数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table couponUsePay = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;coupon_id&#x27;] coupon_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(data[&#x27;used_time&#x27;],&#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;used_time&#x27;] used_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`old`,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;coupon_use&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;update&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and data[&#x27;used_time&#x27;] is not null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;coupon_use_pay&quot;, couponUsePay);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 建立 Upsert-Kafka dwd_tool_coupon_order 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_tool_coupon_pay(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;payment_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_tool_coupon_pay&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 将数据写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_tool_coupon_pay select &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;coupon_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;used_time payment_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts from coupon_use_pay&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="互动域收藏商品事务事实表">互动域收藏商品事务事实表<a class="hash-link" href="#互动域收藏商品事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-14">主要任务<a class="hash-link" href="#主要任务-14" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">读取收藏数据，写入 Kafka 收藏主题</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-12">思路分析<a class="hash-link" href="#思路分析-12" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">用户收藏商品时业务数据库的收藏表会插入一条数据，因此筛选操作类型为 update 的数据即可。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-13">图解<a class="hash-link" href="#图解-13" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167243018-facb2ce6-7b89-47d1-841c-74283d7d1c99.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-13">代码<a class="hash-link" href="#代码-13" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdInteractionFavorAdd {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_interaction_favor_add&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取收藏表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table favorInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(data[&#x27;create_time&#x27;],&#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;create_time&#x27;] create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;favor_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;favor_info&quot;, favorInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 创建 Upsert-Kafka dwd_interaction_favor_add 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_interaction_favor_add (\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_interaction_favor_add&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 将数据写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_interaction_favor_add select * from favor_info&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="互动域评价事务事实表">互动域评价事务事实表<a class="hash-link" href="#互动域评价事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-15">主要任务<a class="hash-link" href="#主要任务-15" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">建立 MySQL-Lookup 字典表，读取评论表数据，关联字典表以获取评价（好评、中评、差评、自动），将结果写入 Kafka 评价主题。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-13">思路分析<a class="hash-link" href="#思路分析-13" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">用户提交评论时评价表会插入一条数据，筛选操作类型为 insert 的数据即可。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-14">图解<a class="hash-link" href="#图解-14" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167243041-aff42c3e-c8b1-46db-ba56-ffb07c1e56da.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-14">代码<a class="hash-link" href="#代码-14" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.MysqlUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdInteractionComment {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 状态后端设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                3, Time.days(1), Time.minutes(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;hdfs://hadoop102:8020/ck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`proc_time` as PROCTIME(),\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_interaction_comment&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取评论表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table commentInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;user_id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;sku_id&#x27;] sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;order_id&#x27;] order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;create_time&#x27;] create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;appraise&#x27;] appraise,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;proc_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;comment_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;comment_info&quot;, commentInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 建立 MySQL-LookUp 字典表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(MysqlUtil.getBaseDicLookUpDDL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 关联两张表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table resultTable = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ci.id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ci.user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ci.sku_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ci.order_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(ci.create_time,&#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ci.create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ci.appraise,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;dic.dic_name,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from comment_info ci\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;left join\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;base_dic for system_time as of ci.proc_time as dic\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;on ci.appraise = dic.dic_code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;result_table&quot;, resultTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 7. 建立 Upsert-Kafka dwd_interaction_comment 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table dwd_interaction_comment(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;sku_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;order_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_id string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;appraise_code string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;appraise_name string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(id) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_interaction_comment&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 8. 将关联结果写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;insert into dwd_interaction_comment select * from result_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="用户域用户注册事务事实表">用户域用户注册事务事实表<a class="hash-link" href="#用户域用户注册事务事实表" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要任务-16">主要任务<a class="hash-link" href="#主要任务-16" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">读取用户表数据，获取注册时间，将用户注册信息写入 Kafka 用户注册主题。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="思路分析-14">思路分析<a class="hash-link" href="#思路分析-14" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">用户注册时会在用户表中插入一条数据，筛选操作类型为 insert 的数据即可。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解-15">图解<a class="hash-link" href="#图解-15" title="标题的直接链接">​</a></h3><p>   <img loading="lazy" src="https://user-images.githubusercontent.com/34996528/167243060-268080b2-fc92-4bd5-aa94-c896fa5043bb.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码-15">代码<a class="hash-link" href="#代码-15" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.atguigu.gmall.realtime.app.dwd.db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.atguigu.gmall.realtime.util.KafkaUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.time.Time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.runtime.state.hashmap.HashMapStateBackend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.CheckpointingMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.Table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.ZoneId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DwdUserRegister {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 1. 环境准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setParallelism(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.getConfig().setLocalTimeZone(ZoneId.of(&quot;GMT+8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 2. 启用状态后端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(3000L, CheckpointingMode.EXACTLY_ONCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().enableExternalizedCheckpoints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(3000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setRestartStrategy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RestartStrategies.failureRateRestart(3, Time.days(1L), Time.minutes(3L))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.setStateBackend(new HashMapStateBackend());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;hdfs://hadoop102:8020/ck&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;atguigu&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 3. 从 Kafka 读取业务数据，封装为 Flink SQL 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table topic_db(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`database` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`table` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`type` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`data` map&lt;string, string&gt;,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getKafkaDDL(&quot;topic_db&quot;, &quot;dwd_trade_order_detail&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 4. 读取用户表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table userInfo = tableEnv.sqlQuery(&quot;select\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;id&#x27;] user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;data[&#x27;create_time&#x27;] create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from topic_db\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;where `table` = &#x27;user_info&#x27;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;and `type` = &#x27;insert&#x27;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.createTemporaryView(&quot;user_info&quot;, userInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 5. 创建 Upsert-Kafka dwd_user_register 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;create table `dwd_user_register`(\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`user_id` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`date_id` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`create_time` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;`ts` string,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;primary key(`user_id`) not enforced\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;)&quot; + KafkaUtil.getUpsertKafkaDDL(&quot;dwd_user_register&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 6. 将输入写入 Upsert-Kafka 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableEnv.executeSql(&quot;insert into dwd_user_register\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;select \n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;user_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;date_format(create_time, &#x27;yyyy-MM-dd&#x27;) date_id,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;create_time,\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;from user_info&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/Bigdata_Blog_Website/blog/tags/数据仓库">数据仓库</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/Bigdata_Blog_Website/blog/mysql cdc 整库同步"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">技术思想</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Bigdata_Blog_Website/blog/实时数仓理论基础"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">实时数仓理论基础</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#配置表" class="table-of-contents__link toc-highlight">配置表</a><ul><li><a href="#flink-cdc" class="table-of-contents__link toc-highlight">Flink CDC</a></li><li><a href="#配置表设计" class="table-of-contents__link toc-highlight">配置表设计</a></li></ul></li><li><a href="#主要任务" class="table-of-contents__link toc-highlight">主要任务</a><ul><li><a href="#接收kafka数据过滤空值数据" class="table-of-contents__link toc-highlight">接收Kafka数据，过滤空值数据</a></li><li><a href="#动态拆分维度表功能" class="table-of-contents__link toc-highlight">动态拆分维度表功能</a></li><li><a href="#把流中的数据保存到对应的维度表" class="table-of-contents__link toc-highlight">把流中的数据保存到对应的维度表</a></li></ul></li><li><a href="#代码实现" class="table-of-contents__link toc-highlight">代码实现</a><ul><li><a href="#接收kafka数据过滤空值数据-1" class="table-of-contents__link toc-highlight">接收Kafka数据，过滤空值数据</a></li><li><a href="#根据mysql的配置表动态进行分流" class="table-of-contents__link toc-highlight">根据MySQL的配置表，动态进行分流</a></li><li><a href="#保存维度到hbasephoenix" class="table-of-contents__link toc-highlight">保存维度到HBase(Phoenix)</a></li></ul></li><li><a href="#流量域未经加工的事务事实表" class="table-of-contents__link toc-highlight">流量域未经加工的事务事实表</a><ul><li><a href="#主要任务-1" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#图解" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#流量域独立访客事务事实表" class="table-of-contents__link toc-highlight">流量域独立访客事务事实表</a><ul><li><a href="#主要任务-2" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-1" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-1" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#流量域用户跳出事务事实表" class="table-of-contents__link toc-highlight">流量域用户跳出事务事实表</a><ul><li><a href="#主要任务-3" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-1" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-2" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-2" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域加购事务事实表" class="table-of-contents__link toc-highlight">交易域加购事务事实表</a><ul><li><a href="#主要任务-4" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-2" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-3" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-3" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域订单预处理表" class="table-of-contents__link toc-highlight">交易域订单预处理表</a><ul><li><a href="#主要任务-5" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-3" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-4" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-4" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域下单事务事实表" class="table-of-contents__link toc-highlight">交易域下单事务事实表</a><ul><li><a href="#主要任务-6" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-4" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-5" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-5" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域取消订单事务事实表" class="table-of-contents__link toc-highlight">交易域取消订单事务事实表</a><ul><li><a href="#主要任务-7" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-5" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-6" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-6" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域支付成功事务事实表" class="table-of-contents__link toc-highlight">交易域支付成功事务事实表</a><ul><li><a href="#主要任务-8" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-6" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-7" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-7" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域退单事务事实表" class="table-of-contents__link toc-highlight">交易域退单事务事实表</a><ul><li><a href="#主要任务-9" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-7" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-8" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-8" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#交易域退款成功事务事实表" class="table-of-contents__link toc-highlight">交易域退款成功事务事实表</a><ul><li><a href="#主要任务-10" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-8" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-9" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-9" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#工具域优惠券领取事务事实表" class="table-of-contents__link toc-highlight">工具域优惠券领取事务事实表</a><ul><li><a href="#主要任务-11" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-9" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-10" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-10" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#工具域优惠券使用下单事务事实表" class="table-of-contents__link toc-highlight">工具域优惠券使用（下单）事务事实表</a><ul><li><a href="#主要任务-12" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-10" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-11" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-11" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#工具域优惠券使用支付事务事实表" class="table-of-contents__link toc-highlight">工具域优惠券使用(支付)事务事实表</a><ul><li><a href="#主要任务-13" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-11" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-12" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-12" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#互动域收藏商品事务事实表" class="table-of-contents__link toc-highlight">互动域收藏商品事务事实表</a><ul><li><a href="#主要任务-14" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-12" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-13" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-13" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#互动域评价事务事实表" class="table-of-contents__link toc-highlight">互动域评价事务事实表</a><ul><li><a href="#主要任务-15" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-13" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-14" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-14" class="table-of-contents__link toc-highlight">代码</a></li></ul></li><li><a href="#用户域用户注册事务事实表" class="table-of-contents__link toc-highlight">用户域用户注册事务事实表</a><ul><li><a href="#主要任务-16" class="table-of-contents__link toc-highlight">主要任务</a></li><li><a href="#思路分析-14" class="table-of-contents__link toc-highlight">思路分析</a></li><li><a href="#图解-15" class="table-of-contents__link toc-highlight">图解</a></li><li><a href="#代码-15" class="table-of-contents__link toc-highlight">代码</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Bigdata_Blog_Website/docs/overview">Overview</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/SophiaData/Bigdata_Blog_Website/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Bigdata_Blog_Website/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/SophiaData/Bigdata_Blog_Website" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 sophiadata, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/Bigdata_Blog_Website/assets/js/runtime~main.235b48d2.js"></script>
<script src="/Bigdata_Blog_Website/assets/js/main.6b17f54e.js"></script>
</body>
</html>